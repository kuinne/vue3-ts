var t=null,e=null;const i=function(t){this.osdMode=1,this.hasblackarea=!1,this.balckRule={},this.osdFrontDatas=[],this.fillcolor="",this.color="",this.showmore=!0,this.ruleIds=[],this.deleteStatus=!1,this.deleteId=null,this.eventtype=[],this.eventFunc=[],this.event=[],this.drawStaus=!1,this.drawColor="",this.unselectedColor="",this.streamCanvas=null,this.drawCanvas=null,this.rulesCanvas=null,this.canvasctx=null,this.drawType=null,this.allPolygons=[],this.drawPolygon=[],this.isDrawing=!1,this.width=0,this.height=0,this.moveCoord=[],this.name="",this.insideName="",this.directBool=!1,this.directText=!1,this.direct=1,this.drawMore=!1,this.idNumber=[],this.needdraw=!1,this.nch=0,this.canDrag=!1,this.dragCoor=[],this.dragIndex=-1,this.unittext="°C",this.maxPolyonP=12,this.gridLine=0,this.gridColumn=0,this.fireType=0,this.gridArr=[],this.gridNumArr=[],this.gridNumArr2=[],this.gridMove=!1,this.isNormal=!0,this.cricleMarginPoint=[]};i.prototype={init:function(t,e,i,s,a,r,n,o,l){this.streamCanvas=t,this.drawStaus=e,this.drawColor=i,this.unselectedColor=s,this.drawMore=!1,this.needdraw=r?1:0,this.nch=n,this.drawCanvas=this.createCanvas(r),this.canDrag=o,this.isNormal=l;var h=this.streamCanvas.parentNode;r||1==h.childNodes.length?h.appendChild(this.drawCanvas):h.insertBefore(this.drawCanvas,h.childNodes[1]),this.canvasctx=this.drawCanvas.getContext("2d"),this.width=this.drawCanvas.width,this.height=this.drawCanvas.height,r&&this.addEventListener()},addGridCanvas(t,e,i){this.gridLine=t,this.gridColumn=e;var s=this.createCanvas(2),a=this.streamCanvas.parentNode;a.insertBefore(s,a.childNodes[a.childNodes.length-1]);var r=s.getContext("2d"),n=s.width,o=s.height,l=n/t,h=o/e;r.beginPath();for(var c=[],d=0;d<e;d++)for(var u=0;u<t;u++)c.push([{x:u*l,y:d*h},{x:(u+1)*l,y:(d+1)*h}]);this.gridArr=c;for(d=1;d<t;d++)r.moveTo(l*d,0),r.lineTo(l*d,o);for(u=1;u<e;u++)r.moveTo(0,h*u),r.lineTo(n,h*u);r.strokeStyle=i,r.stroke(),r.closePath()},changeDrawStaus(t){this.drawStaus=t,this.isDrawing=t},dragStatus(t){this.canDrag=t,this.canDrag&&(this.isDrawing=!1)},close(){this.clearCanvas(),this.removeEventListens(),this.removeDom()},setUnit(t){this.unittext=0==t?"°C":1==t?"°F":"K"},removeDom(){this.drawCanvas.parentNode.removeChild(this.drawCanvas)},createCanvas:function(t){var e=this.streamCanvas.getBoundingClientRect(),i=document.createElement("canvas"),s=this.streamCanvas.offsetLeft,a=this.streamCanvas.offsetTop;return i.style.position="absolute",i.style.width=e.width+"px",i.style.height=e.height+"px",i.style.left=s+"px",i.style.top=a+"px",i.width=e.width,i.height=e.height,1==t?i.id="canvasdraw"+this.nch:0==t?i.id="intellshow"+this.nch:2==t&&(i.id="grid"+this.nch),i},addEvent(t,e){this.eventtype=t,this.eventFunc=e,this.event=[];for(var i=0;i<t.length;i++)this.event.push(new Event(t[i])),this.drawCanvas&&this.drawCanvas.addEventListener(t[i],e[i],!1)},setCallback(i,s){for(var a=0;a<i.length;a++)"getTemperature"==i[a]&&(t=s[a]),"getCurCh"==i[a]&&(e=s[a])},removeEvent(t,e){this.drawCanvas&&this.drawCanvas.removeEventListener(t,e)},addEventListener:function(){this.drawCanvas.addEventListener("mousemove",this.mouseMove.bind(this)),this.drawCanvas.addEventListener("mouseup",this.mouseUp.bind(this)),this.drawCanvas.addEventListener("mousedown",this.mouseDown.bind(this)),this.drawCanvas.addEventListener("contextmenu",this.endDraw.bind(this))},removeEventListens:function(){this.drawCanvas.removeEventListener("mousemove",this.mouseMove),this.drawCanvas.removeEventListener("mouseup",this.mouseUp),this.drawCanvas.removeEventListener("mousedown",this.mouseDown),this.drawCanvas.removeEventListener("contextmenu",this.endDraw)},setOsdMode(t){this.osdMode=t},osdModeFront:function(t){var e=t.datas;t.bool,this.osdFrontDatas=a(e,this.width,this.height)},hasBlack(t){this.hasblackarea=t},showBlackRule(t){t&&(this.balckRule=a(t,this.width,this.height)[0]),this.allPolygons=[this.balckRule],this.showAllRules()},showallPolygons:function(t){this.allPolygons=[],0!=t.length?(this.drawCanvas&&(this.width=this.drawCanvas.width,this.height=this.drawCanvas.height),t&&t.length>0?(this.allPolygons=a(t,this.width,this.height),this.showAllRules()):this.allPolygons=[]):this.clearCanvas()},createCRule:function(t){this.drawType=t.type,this.color=t.color,this.showmore=t.showmore,this.name=t.name,this.insideName=t.insideName,this.color=t.color,this.fillcolor=t.fillcolor,this.directBool=t.directBool,this.directText=t.directText,this.direct=t.direct,this.drawPolygon=[],this.moveCoord=[],this.isDrawing=!0,this.isFire=t.isFire,this.isDynamic=t.isDynamic,this.fireType=t.fireType,this.deleteStatus=!1,this.changeDrawStaus(!0)},mouseMove:function(t){if(6==this.drawType&&this.drawPolygon.length>0&&this.gridMove){var e={x:(a=u(this.drawCanvas,t))[0],y:a[1]};return this.drawPolygon=this.drawPolygon.slice(0,1),this.drawPolygon.push(e),this.gridMove=!1,void this.computerGrid()}if(!this.canDrag||this.isDrawing||this.deleteStatus){if(this.drawStaus&&this.isDrawing&&0!=this.drawPolygon.length&&(this.moveCoord=[],this.isDrawing&&(2==this.drawType||3==this.drawType||4==this.drawType||7==this.drawType))){var i=u(this.drawCanvas,t),s={x:i[0],y:i[1]};this.moveCoord.push(s),this.onDrawing()}}else{var a;e={x:(a=u(this.drawCanvas,t))[0],y:a[1]};if(-1==this.dragIndex)return;if(this.dragCoor.length>0){this.dragCoor[1]=e;var r=this.dragCoor[1].x-this.dragCoor[0].x,n=this.dragCoor[1].y-this.dragCoor[0].y,o=!0,l=!0,h=[];h=0==this.allPolygons.length?this.osdFrontDatas:this.allPolygons;var c=JSON.parse(JSON.stringify(this.drawPolygon));if("Circle"==h[0].subtype){var d=h[0].coord,f=Math.sqrt(Math.pow(d[1].y-d[0].y,2)+Math.pow(d[1].x-d[0].x,2));c[0].x+=r,c[0].y+=n,(f+4>c[0].x||f+4>this.width-c[0].x)&&(o=!1),(f+4>c[0].y||f+4>this.height-c[0].y)&&(l=!1)}else{c=JSON.parse(JSON.stringify(this.drawPolygon));for(var p=0;p<c.length;p++)c[p].x+=r,c[p].y+=n,(c[p].x<4||c[p].x>this.width-4)&&(o=!1),(c[p].y<4||c[p].y>this.height-4)&&(l=!1)}if(!o&&!l)return;for(p=0;p<this.drawPolygon.length;p++)o&&(this.drawPolygon[p].x+=r),l&&(this.drawPolygon[p].y+=n);this.dragCoor[0]=e,this.onDrawing()}}},mouseUp(t){if(!this.canDrag||this.isDrawing||this.deleteStatus){if(this.drawStaus&&6===this.drawType){var e=u(this.drawCanvas,t),i={x:e[0],y:e[1]};this.drawPolygon.push(i),this.computerGrid(),this.gridMove=!1,this.gridNumArr=JSON.parse(JSON.stringify(this.gridNumArr2)),this.drawCanvas.dispatchEvent(this.event[0])}}else{if(-1==this.dragIndex)return;this.drawCanvas.dispatchEvent(this.event[0])}},mouseDown:function(t){if(!(3==t.which&&3===this.drawType||3==t.which&&this.deleteStatus)){if("cali"==this.isNormal){var i=t.target.id.replace(/[^0-9]/gi,"");e(i),this.nch=i,this.drawCanvas=0==i?document.getElementById("canvasdraw0"):document.getElementById("canvasdraw1")}if(this.canDrag&&!this.isDrawing&&!this.deleteStatus){this.dragCoor=[],this.drawType=null;var s=u(this.drawCanvas,t),a={x:s[0],y:s[1]};this.osdFrontDatas.length>0&&(this.allPolygons=[]);var r=this.deletePolyon(t);if("Mask"===r.subtype)return;return this.dragIndex=r.index,this.drawPolygon=r.coord,this.dragCoor=[a],void(this.osdFrontDatas.length>0&&(this.allPolygons=[r]))}if(this.drawStaus||this.deleteStatus){if(!this.isDrawing&&this.deleteStatus)return this.deleteId=JSON.parse(JSON.stringify(this.deletePolyon(t))),void(null===this.deleteId?this.drawCanvas.dispatchEvent(this.event[1]):(this.drawCanvas.dispatchEvent(this.event[1]),this.showmore||(this.allPolygons=[]),this.showmore&&(this.allPolygons.splice(this.deleteId.index,1),this.showAllRules())));if(this.isDrawing){this.showmore||(this.allPolygons=[]);var n=u(this.drawCanvas,t),o={x:n[0],y:n[1]};if(6==this.drawType)return this.drawPolygon=[],this.drawPolygon.push(o),void(this.gridMove=!0);if(!(this.drawPolygon.length>2&&function(t,e){for(var i=!1,s=0;l=e.length,s<l-1;s++){var a=e[s],r=e[s+1];if(!i&&h(t,e[l-1],a,r)){i=!0;break}}return i}(o,this.drawPolygon))){if(this.drawPolygon.push(o),this.drawPolygon.length==this.maxPolyonP){if(!this.hasCross(this.drawPolygon))return this.drawPolygon=[],this.moveCoord=[],void this.onDrawing();this.isDrawing=!1}this.onDrawing()}}}}},endDraw:function(t){if((t.preventDefault(),!this.deleteStatus)&&(!(2===this.drawType&&this.drawPolygon.length<2)&&!(3===this.drawType&&this.drawPolygon.length<3)&&4!==this.drawType&&6!==this.drawType&&this.drawStaus))return this.hasCross(this.drawPolygon)?(this.isDrawing=!1,this.onDrawing(),!1):(console.log("线段不能相交"),this.drawPolygon=[],this.moveCoord=[],void this.onDrawing())},computerGrid:function(){var t=[],e=[],i=[...this.drawPolygon];if(i[0].x>i[1].x&&i[0].y<i[1].y){let t=[];t=[{x:i[1].x,y:i[0].y},{x:i[0].x,y:i[1].y}],i=t}if(i[0].x<i[1].x&&i[0].y>i[1].y){let t=[];t=[{x:i[0].x,y:i[1].y},{x:i[1].x,y:i[0].y}],i=t}if(i[0].x>i[1].x||i[0].y>i[1].y){let t=[];t[0]=i[1],t[1]=i[0],i=t}for(var s=0,a=this.gridArr.length;s<a;s++)this.gridArr[s][0].x>i[1].x||this.gridArr[s][1].x<i[0].x||this.gridArr[s][0].y>i[1].y||this.gridArr[s][1].y<i[0].y?t.push(-1):(e.push(s),t.push(this.fireType));if(this.gridNumArr2=[...this.gridNumArr],this.gridNumArr.length>0)for(var r=0,n=e.length;r<n;r++)this.gridNumArr[e[r]]==t[e[r]]?-1==t[e[r]]?this.gridNumArr2[e[r]]=this.fireType:this.gridNumArr2[e[r]]=-1:this.gridNumArr2[e[r]]=this.fireType;else this.gridNumArr2=[...t];this.drawFireGrids(),this.gridMove=!0},drawFireGrids(){this.clearCanvas();for(var t=0,e=this.gridNumArr2.length;t<e;t++)-1!=this.gridNumArr2[t]&&(0==this.gridNumArr2[t]?this.canvasctx.fillStyle="rgba(0,160,233,0.3)":1==this.gridNumArr2[t]?this.canvasctx.fillStyle="rgba(255,241,0,0.3)":2==this.gridNumArr2[t]?this.canvasctx.fillStyle="rgba(98,182,47,0.3)":3==this.gridNumArr2[t]&&(this.canvasctx.fillStyle="rgba(215,13,24,0.3)"),this.canvasctx.fillRect(this.gridArr[t][0].x,this.gridArr[t][0].y,this.gridArr[t][1].x-this.gridArr[t][0].x,this.gridArr[t][1].y-this.gridArr[t][0].y))},showFireGrids(t){this.gridNumArr=JSON.parse(JSON.stringify(t)),this.gridNumArr2=JSON.parse(JSON.stringify(t)),this.drawFireGrids()},hasCross(t){var e=t.length,i=t[e-1].x,s=t[e-1].y,a=t[0].x,r=t[0].y;if(result=!0,e>=4)for(var n=1;n<e-2;n++){var o=t[n].x,l=t[n].y,h=t[n+1].x,c=t[n+1].y;if(result=!d(i,s,a,r,o,l,h,c),!result)break}return result},onDrawing:function(){this.showAllRules()},clearDatas:function(){this.allPolygons=[],this.osdFrontDatas=[],this.gridNumArr=[]},clearCanvas:function(){this.drawCanvas&&(this.canvasctx=this.drawCanvas.getContext("2d"),this.canvasctx.clearRect(0,0,this.width,this.height))},selectOneRegion:function(){return 0},deletePolyon(t){var e=this.drawCanvas.getBoundingClientRect(),i=[];if(0!=(i=this.osdFrontDatas.length>0?this.osdFrontDatas:this.allPolygons).length){for(var s=[t.clientX-e.x,t.clientY-e.y],a=0;a<i.length;a++){for(var r=i[a],n=[],o=r.coord,l=0;l<o.length;l++){var h=[o[l].x,o[l].y];n.push(h)}4==r.type&&((n=[]).push([o[0].x,o[0].y]),n.push([o[1].x,o[0].y]),n.push([o[1].x,o[1].y]),n.push([o[0].x,o[1].y]));if(1==r.type&&this.insideCircle(s,n,10))return r.index=a,r;if(2==r.type&&this.insideLineM(s,n))return r.index=a,r;if((3==r.type||4==r.type)&&this.insidePolygon(s,n))return r.index=a,r;if(7==r.type&&this.insideCircleArea(s,n))return r.index=a,r}return null}},insideCircle(t,e,i){if(0===i)return!1;var s=e[0][0]-t[0],a=e[0][1]-t[1];return s*s+a*a<=i*i},insideLineM(t,e){var i=e[0][0],s=e[0][1],a=e[1][0],r=e[1][1],n=o(i,s,a,r,i,s,20),l=o(i,s,a,r,a,r,20),h=[[n[0],n[1]],[n[2],n[3]],[l[2],l[3]],[l[0],l[1]]];return this.insidePolygon(t,h)},insideLine(t,e){for(let i=1;i<e.length;i++){let s=e[i-1],a=e[i];if(this.onSegment(s,a,t))return[s,a]}return null},onSegment(t,e,i){t={x:t[0],y:t[1]},e={x:e[0],y:e[1]},i={x:i[0],y:i[1]};let s=((e.y-t.y)/(e.x-t.x)).toFixed(3),a=((i.y-t.y)/(i.x-t.x)).toFixed(3);return Math.abs(a-s)-.1<=Number.EPSILON?[t,e]:null},insidePolygon(t,e){for(var i=t[0],s=t[1],a=!1,r=0,n=e.length-1;r<e.length;n=r++){var o=e[r][0],l=e[r][1],h=e[n][0],c=e[n][1];l>s!=c>s&&i<(h-o)*(s-l)/(c-l)+o&&(a=!a)}return a},insideCircleArea(t,e){let i=!1;return Math.sqrt(Math.pow(e[1][1]-e[0][1],2)+Math.pow(e[1][0]-e[0][0],2))>=Math.sqrt(Math.pow(t[1]-e[0][1],2)+Math.pow(t[0]-e[0][0],2))&&(i=!0),i},showAllRules:function(){this.clearCanvas(),this.idNumber=[],this.drawPolygon.length>0&&this.showRule();for(var e=this.allPolygons.length,i=0;i<e;i++){var s=this.allPolygons[i];this.showRule(s)}if(this.allPolygons.length&&this.allPolygons[this.allPolygons.length-1]&&this.allPolygons[this.allPolygons.length-1].istemper)try{t(this.allPolygons)}catch(t){}},drawLeftTemperText(t,e,i,s){var a=1==i?10:this.drawCanvas.width-220;this.canvasctx.font="bold 14px Arial",1==t.type?(this.canvasctx.fillText("> "+t.name,a,20+s),this.canvasctx.fillText(t.name,a+50,20+s)):(this.canvasctx.fillText("> "+t.name,a,20+s),this.canvasctx.fillText("Cen "+t.name,a,20+s+20),this.canvasctx.fillText("AVG "+t.name,a+100,20+s+20),this.canvasctx.fillText("MAX "+t.name,a,20+s+40),this.canvasctx.fillText("MIN "+t.name,a+100,20+s+40))},showRule:function(t){if(t)switch(t.type){case 1:this.drawPoint(t);break;case 2:case 3:case 4:this.drawPoly(t);break;case 7:this.drawCricle(t);break;case 9:this.drawFullFrame(t)}t||(1==this.drawType?this.drawPoint():2==this.drawType||3==this.drawType||4==this.drawType?this.drawPoly():7==this.drawType&&this.drawCricle())},drawCricle(t){if(t){let a=t.hasHTem,r=t.hasLTem,n=t&&t.color?t.color:"#FFFFFF",o=t.name,l=!0;t.fillcolor&&t.fillcolor;let h=0==t.temperunit?-273.2:1==t.temperunit?-459.8:0,c=t.coord,d="";l=!!t.istemper&&!(t.tempermax==h&&t.tempermin==h&&t.temperavg==h&&(null==t.maxcoord.x&&null==t.maxcoord.y||0==t.maxcoord.x&&0==t.maxcoord.y&&0==t.mincoord.x&&0==t.mincoord.y)),'{"RGBA":[0,0,0,100]}'==JSON.stringify(t.color)&&(l=!1),0===t.temperunit?d="°C":1==t.temperunit?d="°F":2==t.temperunit&&(d="K"),"object"==typeof n?(this.canvasctx.fillStyle="rgba("+n.RGBA[0]+","+n.RGBA[1]+","+n.RGBA[2]+",1)",this.canvasctx.strokeStyle="rgba("+n.RGBA[0]+","+n.RGBA[1]+","+n.RGBA[2]+",1)"):n?(this.canvasctx.fillStyle=n,this.canvasctx.strokeStyle=n):(this.canvasctx.fillStyle=this.color,this.canvasctx.strokeStyle=this.color),this.canvasctx.lineWidth=2;var e=c[0].x,i=c[0].y,s=Math.sqrt(Math.pow(c[1].y-c[0].y,2)+Math.pow(c[1].x-c[0].x,2));this.canvasctx.beginPath(),this.canvasctx.arc(e,i,s,0,2*Math.PI),this.canvasctx.stroke();let u=this.formatTemp(t.tempermax,1),f=this.formatTemp(t.tempermin,1),p=this.formatTemp(t.temperavg,1);if(this.canvasctx.fillStyle="object"==typeof n?"rgba("+n.RGBA[0]+","+n.RGBA[1]+","+n.RGBA[2]+",1)":n||this.color,this.canvasctx.font="14px Normal Arial",this.canvasctx.fillText(o,e,i),l){let s=0,n=0;e+90>this.drawCanvas.width&&(s=-50),i+60>this.drawCanvas.height&&(n=-70),this.canvasctx.fillText("MAX "+u+d,e+s,i+n+14),this.canvasctx.fillText("MIN "+f+d,e+s,i+n+34),this.canvasctx.fillText("AVG "+p+d,e+s,i+n+54),a&&this.drawArrow(t.maxcoord.x,t.maxcoord.y,t.maxcoord,40,2),r&&this.drawArrow(t.mincoord.x,t.mincoord.y,t.mincoord,40,1)}}else{if(this.drawPolygon.length>0&&this.moveCoord.length>0){let t=n([this.drawPolygon[0],this.moveCoord[0]],this.drawCanvas.width,this.drawCanvas.height);t[0].x=+t[0].x.toFixed(0),t[0].y=+t[0].y.toFixed(0),t[1].x=+t[1].x.toFixed(0),t[1].y=+t[1].y.toFixed(0);let a=(t[1].y-t[0].y)/(t[1].x-t[0].x),r=(90-Math.abs(180*Math.atan(a)/Math.PI))/90*(1.37-1);(s=Math.sqrt(Math.pow(t[1].y-t[0].y,2)+Math.pow(t[1].x-t[0].x,2)))+t[0].x<8191&&t[0].x-s>1&&s*(1+r)+t[0].y<8191&&t[0].y-s*(1+r)>1&&(this.cricleMarginPoint=this.moveCoord[0]),this.canvasctx.strokeStyle=this.color,this.canvasctx.lineWidth=2;e=this.drawPolygon[0].x,i=this.drawPolygon[0].y,s=Math.sqrt(Math.pow(this.cricleMarginPoint.y-this.drawPolygon[0].y,2)+Math.pow(this.cricleMarginPoint.x-this.drawPolygon[0].x,2));this.canvasctx.beginPath(),this.canvasctx.arc(e,i,s,0,2*Math.PI),this.canvasctx.stroke()}if(2==this.drawPolygon.length&&this.isDrawing){this.drawPolygon[1]=this.cricleMarginPoint,this.drawCanvas.dispatchEvent(this.event[0]);var a={index:this.allPolygons.length-1,type:this.drawType,name:this.name,insideName:this.insideName,coord:[{x:rect[0].x,y:rect[0].y},{x:rect[1].x,y:rect[1].y}],directBool:directBool,directText:directText,direct:direct};return this.drawCanvas.dispatchEvent(this.event[0]),this.drawPolygon=[],void(this.showmore?this.allPolygons.push(a):this.allPolygons=[a])}}},drawFullFrame(t){for(var e=!1,i=!1,a=0;a<s.length;a++){var r=s[a];t.maxcoord.x>=r.coord[0].x&&t.maxcoord.x<=r.coord[1].x&&t.maxcoord.y>=r.coord[0].y&&t.maxcoord.y<=r.coord[1].y&&(e=!0),t.mincoord.x>=r.coord[0].x&&t.mincoord.x<=r.coord[1].x&&t.mincoord.y>=r.coord[0].y&&t.mincoord.y<=r.coord[1].y&&(i=!0)}var n="";0===t.temperunit?n="°C":1==t.temperunit?n="°F":2==t.temperunit&&(n="K");let o=0==t.temperunit?-273.2:1==t.temperunit?-459.8:0;!(t.tempermax==o&&t.tempermin==o&&t.temperavg==o&&(null==t.maxcoord.x&&null==t.maxcoord.y||0==t.maxcoord.x&&0==t.maxcoord.y&&0==t.mincoord.x&&0==t.mincoord.y))&&(this.canvasctx.fillStyle="#FFFFFF",t.tempermax=this.formatTemp(t.tempermax,1),t.tempermin=this.formatTemp(t.tempermin,1),e||(t.maxcoord.y+24>this.height?this.canvasctx.fillText(t.tempermax+n,t.maxcoord.x-20,t.maxcoord.y-8):this.canvasctx.fillText(t.tempermax+n,t.maxcoord.x-20,t.maxcoord.y+26)),i||(t.mincoord.y-24<0?this.canvasctx.fillText(t.tempermin+n,t.mincoord.x-20,t.mincoord.y+14):this.canvasctx.fillText(t.tempermin+n,t.mincoord.x-20,t.mincoord.y-14)),e||this.drawArrow(null,null,t.maxcoord,50,2,!0),i||this.drawArrow(null,null,t.mincoord,50,1,!0),i&&e||(this.canvasctx.fill(),this.canvasctx.closePath()))},drawPoint:function(t){var e=!1,i=t?t.coord[0].x:0,s=t?t.coord[0].y:0,a=t&&t.color?t.color:"#FFFFFF";if(this.canvasctx.lineWidth=2,t&&t.istemper){let i=0==t.temperunit?-273.2:1==t.temperunit?-459.8:0;e=!(t.tempermax==i&&t.tempermin==i&&t.temperavg==i)}if('{"RGBA":[0,0,0,100]}'==JSON.stringify(a)&&(e=!1),!t&&this.isDrawing&&1==this.drawType){this.drawPolygon.length>0&&1==this.drawType&&(i=this.drawPolygon[this.drawPolygon.length-1].x,s=this.drawPolygon[this.drawPolygon.length-1].y,this.isDrawing=!1);var r={index:this.allPolygons.length-1,type:1,name:this.name,insideName:this.insideName,coord:[{x:i,y:s}],directBool:!1,directText:!1,direct:0};this.drawCanvas.dispatchEvent(this.event[0]),this.showmore&&this.allPolygons.push(r),this.drawPolygon=[]}this.canvasctx.beginPath(),this.canvasctx.moveTo(i-3,s),this.canvasctx.lineTo(i-13,s),this.canvasctx.moveTo(i,s+3),this.canvasctx.lineTo(i,s+13),this.canvasctx.moveTo(i+3,s),this.canvasctx.lineTo(i+13,s),this.canvasctx.moveTo(i,s-3),this.canvasctx.lineTo(i,s-13),"object"==typeof a?(this.canvasctx.fillStyle="rgba("+a.RGBA[0]+","+a.RGBA[1]+","+a.RGBA[2]+",1)",this.canvasctx.strokeStyle="rgba("+a.RGBA[0]+","+a.RGBA[1]+","+a.RGBA[2]+",1)"):a?(this.canvasctx.fillStyle=a,this.canvasctx.strokeStyle=a):(this.canvasctx.fillStyle=this.color,this.canvasctx.strokeStyle=this.color),this.canvasctx.stroke();var n=!1,o=!1;if(i+100>this.drawCanvas.width&&(n=!0),s+100>this.drawCanvas.height&&(o=!0),t&&t.name){this.canvasctx.font="14px Normal Arial";var l=i+6,h=s+16;n&&(l=i-26),o&&(h=s-6),this.canvasctx.fillText(t.name,l,h)}if(t&&t.istemper){this.canvasctx.font="14px Normal Arial";var c="";if(0==t.temperunit?c="°C":1==t.temperunit?c="°F":2==t.temperunit&&(c="K"),e){var d=i+6,u=s+32;n&&(d=i-46),o&&(u=s-22),this.canvasctx.fillText(this.formatTemp(t.tempermax,1)+c,d,u)}}this.canvasctx.fill(),this.canvasctx.closePath()},formatTemp:function(t,e){let i=(t=t.toString()).indexOf(".");return t=-1!==i?t.substring(0,e+i+1):t.substring(0),parseFloat(t).toFixed(e)},showTime:function(t){this.canvasctx.fillStyle="rgba(215,13,24,1)",this.canvasctx.fillRect(40,40,400,20),this.canvasctx.font="14px Arial",this.canvasctx.fillStyle="#000000",this.canvasctx.fillText(t,50,50)},drawPoly:function(t){var e=0,i=[],s=!1,a=!1,r=0,n=!1,o=!1,l=null,h=null,c=null,d=!1,u="",f=!1,p=!1,g=!1;if(t){if(p=t.isFire,g=t.isDynamic,e=t.type,i=t.coord,s=t.directBool,a=t.directText,r=t.direct,n=t.hasHTem,o=t.hasLTem,l=t&&t.color?t.color:"#FFFFFF",h=t.name,f=t.istemper,c=t.fillcolor?t.fillcolor:null,t.istemper){let e=0==t.temperunit?-273.2:1==t.temperunit?-459.8:0;f=!(t.tempermax==e&&t.tempermin==e&&t.temperavg==e&&(null==t.maxcoord.x&&null==t.maxcoord.y||0==t.maxcoord.x&&0==t.maxcoord.y&&0==t.mincoord.x&&0==t.mincoord.y))}'{"RGBA":[0,0,0,100]}'==JSON.stringify(t.color)&&(f=!1),0===t.temperunit?u="°C":1==t.temperunit?u="°F":2==t.temperunit&&(u="K"),"object"==typeof l?(this.canvasctx.fillStyle="rgba("+l.RGBA[0]+","+l.RGBA[1]+","+l.RGBA[2]+",1)",this.canvasctx.strokeStyle="rgba("+l.RGBA[0]+","+l.RGBA[1]+","+l.RGBA[2]+",1)"):l?(this.canvasctx.fillStyle=l,this.canvasctx.strokeStyle=l):(this.canvasctx.fillStyle=this.color,this.canvasctx.strokeStyle=this.color),this.canvasctx.lineWidth=2,d=!1}else{if(p=this.isFire,g=this.isDynamic,c=this.fillcolor,e=this.drawType,i=this.drawPolygon,s=this.directBool,a=this.directText,r=this.direct,this.canvasctx.strokeStyle=this.color,this.canvasctx.lineWidth=2,h=this.name,l=this.color,d=!0,(2==e||4==e)&&2==this.drawPolygon.length&&this.isDrawing){this.isDrawing=!1;var y={index:this.allPolygons.length-1,type:e,name:this.name,insideName:this.insideName,coord:[{x:i[0].x,y:i[0].y},{x:i[1].x,y:i[1].y}],directBool:s,directText:a,direct:r};s||(this.drawCanvas.dispatchEvent(this.event[0]),this.drawPolygon=[]),this.showmore?this.allPolygons.push(y):this.allPolygons=[y]}if(3==e&&this.drawPolygon.length>2&&!this.isDrawing){for(var m=[],v=0;v<i.length;v++){var x={x:i[v].x,y:i[v].y};m.push(x)}y={type:e,name:this.name,insideName:this.insideName,coord:m,directBool:s,directText:!1,direct:r};this.isDrawing=!1,s||(this.drawCanvas.dispatchEvent(this.event[0]),this.drawPolygon=[]),this.allPolygons.push(y)}}if((T=i.length)>0){if(this.canvasctx.beginPath(),this.canvasctx.moveTo(i[0].x,i[0].y),4!=e&&6!=e)for(v=1;v<T;v++){var w=i[v];this.canvasctx.lineTo(w.x,w.y)}if(this.isDrawing&&this.moveCoord.length>0&&!t)4==e?this.canvasctx.rect(i[0].x,i[0].y,this.moveCoord[0].x-i[0].x,this.moveCoord[0].y-i[0].y):(this.canvasctx.moveTo(i[T-1].x,i[T-1].y),this.canvasctx.lineTo(this.moveCoord[0].x,this.moveCoord[0].y));else{if(2==e&&2==i.length)this.canvasctx.moveTo(i[0].x,i[0].y),this.canvasctx.lineTo(i[1].x,i[1].y),s&&this.drawDirect(i[0].x,i[0].y,i[1].x,i[1].y,30,r,!!d&&"needsave",a,l,t,e,i);else if(4==e&&2==i.length)this.canvasctx.rect(i[0].x,i[0].y,i[1].x-i[0].x,i[1].y-i[0].y),s&&this.drawDirect(i[0].x,i[0].y,i[1].x,i[0].y,30,r,!!d&&"needsave",a,l,t,e,i);else if(i.length>2&&(this.canvasctx.lineTo(i[0].x,i[0].y),s)){var T=i.length;this.drawDirect(i[0].x,i[0].y,i[1].x,i[1].y,30,r,!!d&&"needsave",a,l,t,e,i)}if(c&&(this.canvasctx.fillStyle=c,this.canvasctx.fill()),t&&t.temperinfo&&t.temperinfo.TempMax>=30&&(this.canvasctx.font="18px Normal Arial",this.canvasctx.fillText(this.formatTemp(t.temperinfo.TempMax,1)+u,i[0].x,i[0].y-5)),h)if(s){this.canvasctx.fillStyle="object"==typeof l?"rgba("+l.RGBA[0]+","+l.RGBA[1]+","+l.RGBA[2]+",1)":l||this.color,this.canvasctx.font="14px Arial";var S=i[0].x+6,C=i[0].y-6;C<0&&(C=i[0].y+16),S>this.drawCanvas.width&&(S=i[0].x-16),this.canvasctx.fillText(h,S,C)}else if(t&&t.istemper){var P=90;if(t.tempermax=this.formatTemp(t.tempermax,1),t.tempermin=this.formatTemp(t.tempermin,1),t.temperavg=this.formatTemp(t.temperavg,1),this.canvasctx.fillStyle="object"==typeof l?"rgba("+l.RGBA[0]+","+l.RGBA[1]+","+l.RGBA[2]+",1)":l||this.color,2==e){this.canvasctx.font="14px Normal Arial";var A=(i[1].y-i[0].y)/(i[1].x-i[0].x);if(i[0].x==i[1].x)f&&(this.drawCanvas.width-i[0].x<P?(this.canvasctx.fillText(h,(i[0].x+i[1].x)/2-30,(i[0].y+i[1].y)/2-4),this.canvasctx.fillText("MAX "+t.tempermax,(i[0].x+i[1].x)/2-P,(i[0].y+i[1].y)/2+24),this.canvasctx.fillText("MIN "+t.tempermin,(i[0].x+i[1].x)/2-P,(i[0].y+i[1].y)/2+44),this.canvasctx.fillText("AVG "+t.temperavg,(i[0].x+i[1].x)/2-P,(i[0].y+i[1].y)/2+64)):(this.canvasctx.fillText(h,(i[0].x+i[1].x)/2+30,(i[0].y+i[1].y)/2-4),this.canvasctx.fillText("MAX "+t.tempermax+u,(i[0].x+i[1].x)/2+5,(i[0].y+i[1].y)/2-4),this.canvasctx.fillText("MIN "+t.tempermin+u,(i[0].x+i[1].x)/2+5,(i[0].y+i[1].y)/2+24),this.canvasctx.fillText("AVG "+t.temperavg+u,(i[0].x+i[1].x)/2+5,(i[0].y+i[1].y)/2+44)));else if(i[0].y==i[1].y)f&&(this.drawCanvas.height-i[0].y<P?(this.canvasctx.fillText(h,(i[0].x+i[1].x)/2,(i[0].y+i[1].y)/2-4),this.canvasctx.fillText("MAX "+t.tempermax+u,(i[0].x+i[1].x)/2+20,(i[0].y+i[1].y)/2-44),this.canvasctx.fillText("MIN "+t.tempermin+u,(i[0].x+i[1].x)/2+20,(i[0].y+i[1].y)/2-24),this.canvasctx.fillText("AVG "+t.temperavg+u,(i[0].x+i[1].x)/2+20,(i[0].y+i[1].y)/2-4)):(this.canvasctx.fillText(h,(i[0].x+i[1].x)/2-16,(i[0].y+i[1].y)/2+16),this.canvasctx.fillText("MAX "+t.tempermax+u,(i[0].x+i[1].x)/2,(i[0].y+i[1].y)/2+24),this.canvasctx.fillText("MIN "+t.tempermin+u,(i[0].x+i[1].x)/2,(i[0].y+i[1].y)/2+44),this.canvasctx.fillText("AVG "+t.temperavg+u,(i[0].x+i[1].x)/2,(i[0].y+i[1].y)/2+64)));else{var b=!1,R=!1,D=!1,k=(i[0].x+i[1].x)/2-P,F=(i[0].y+i[1].y)/2;if((i[0].x+i[1].x)/2-P<0&&(D=!0),(i[0].x+i[1].x)/2+10+P>this.drawCanvas.width&&(b=!0),i[0].y,i[1].y,(i[0].y+i[1].y)/2+10+60>this.drawCanvas.height&&(R=!0),A>0){var E=-((i[0].x+i[1].x)/2-P-10);D&&(k=(i[0].x+i[1].x)/2-P+E),F=R?(i[0].y+i[1].y)/2-54:(i[0].y+i[1].y)/2+14,b?this.canvasctx.fillText(h,k+30,(i[0].y+i[1].y)/2-6):this.canvasctx.fillText(h,k+P,(i[0].y+i[1].y)/2-6),f&&(this.canvasctx.fillText("MAX "+t.tempermax+u,k,F),this.canvasctx.fillText("MIN "+t.tempermin+u,k,F+20),this.canvasctx.fillText("AVG "+t.temperavg+u,k,F+40))}else{E=(i[0].x+i[1].x)/2+10+P-this.drawCanvas.width;if(k=b?(i[0].x+i[1].x)/2+10-E:(i[0].x+i[1].x)/2+10,F=R?(i[0].y+i[1].y)/2-54:(i[0].y+i[1].y)/2+14,(i[0].x+i[1].x)/2+10+P>this.drawCanvas.width)this.canvasctx.fillText(h,(i[0].x+i[1].x)/2-24,(i[0].y+i[1].y)/2);else if((i[0].x+i[1].x)/2-24<0){E=-((i[0].x+i[1].x)/2-24);this.canvasctx.fillText(h,(i[0].x+i[1].x)/2+E,(i[0].y+i[1].y)/2)}else this.canvasctx.fillText(h,(i[0].x+i[1].x)/2-24,(i[0].y+i[1].y)/2);f&&(this.canvasctx.fillText("MAX "+t.tempermax+u,k,F),this.canvasctx.fillText("MIN "+t.tempermin+u,k,F+20),this.canvasctx.fillText("AVG "+t.temperavg+u,k,F+40))}}}else{for(var I=null,N=0;N<i.length;N++)null==I?I=i[0]:I.x<i[N].x&&(I=i[N]);this.canvasctx.font="14px Normal Arial";var M=I.x,L=I.y;i[1].x>i[0].x?i[0].x:i[1].x,i[1].y>i[0].y?i[0].y:i[1].y,this.drawCanvas.width-M>P?this.drawCanvas.height-L<60?(this.canvasctx.fillText(h,I.x,I.y-10),f&&(this.canvasctx.fillText("MAX "+t.tempermax+u,M+10,L-24),this.canvasctx.fillText("MIN "+t.tempermin+u,M+10,L-44),this.canvasctx.fillText("AVG "+t.temperavg+u,M+10,L-64))):(this.canvasctx.fillText(h,I.x,I.y+10),f&&(this.canvasctx.fillText("MAX "+t.tempermax+u,M+10,L+24),this.canvasctx.fillText("MIN "+t.tempermin+u,M+10,L+44),this.canvasctx.fillText("AVG "+t.temperavg+u,M+10,L+64))):this.drawCanvas.height-L<60?(this.canvasctx.fillText(h,I.x-P,I.y-10),f&&(this.canvasctx.fillText("MAX "+t.tempermax+u,M-P,L-24),this.canvasctx.fillText("MIN "+t.tempermin+u,M-P,L-44),this.canvasctx.fillText("AVG "+t.temperavg+u,M-P,L-64))):(this.canvasctx.fillText(h,I.x-P,I.y+10),f&&(this.canvasctx.fillText("MAX "+t.tempermax+u,M-P,L+24),this.canvasctx.fillText("MIN "+t.tempermin+u,M-P,L+44),this.canvasctx.fillText("AVG "+t.temperavg+u,M-P,L+64)))}}else i.length>1&&(p||g?(this.canvasctx.font="14px Arial",this.canvasctx.fillStyle="#000000",this.canvasctx.fillText(h,(i[0].x+i[1].x)/2-15,(i[0].y+i[1].y)/2)):(this.canvasctx.font="14px Arial",this.canvasctx.fillText(h,(i[0].x+i[1].x)/2-15,(i[0].y+i[1].y)/2),this.canvasctx.fillStyle=l))}if(this.canvasctx.stroke(),this.canvasctx.closePath(),2==i.length&&2==e&&f&&(n&&this.drawArrow(i[0],i[1],t.maxcoord,40,2),o&&this.drawArrow(i[0],i[1],t.mincoord,40,1)),i.length>2&&3==e&&f){var B={x:i[1].x,y:i[0].y};n&&this.drawArrow(i[0],B,t.maxcoord,40,2),o&&this.drawArrow(i[0],B,t.mincoord,40,1)}}},drawDirect:function(t,e,i,s,a,r,n,l,h,d,u,f){var p=[];p=d&&d.directCoor&&d.directCoor.length>0?[d.directCoor[0].x,d.directCoor[0].y,d.directCoor[1].x,d.directCoor[1].y,(d.directCoor[0].x+d.directCoor[1].x)/2,(d.directCoor[0].y+d.directCoor[1].y)/2]:o(t,e,i,s,null,null,a);var g=o(t,e,i,s,null,null,50);this.canvasctx.moveTo(p[0],p[1]),this.canvasctx.lineTo(p[2],p[3]);var y=function(t,e){var i=o(t[0],t[1],t[4],t[5],null,null,e,4),s=o(t[2],t[3],t[4],t[5],null,null,e,4);return[i,s]}(p,20);if(3==u){p[0],p[1];if(2==r)c({x:p[0],y:p[1]},f)?(this.canvasctx.moveTo(p[2],p[3]),this.canvasctx.lineTo(y[1][0],y[1][1]),this.canvasctx.moveTo(p[2],p[3]),this.canvasctx.lineTo(y[1][2],y[1][3])):(this.canvasctx.moveTo(p[0],p[1]),this.canvasctx.lineTo(y[0][0],y[0][1]),this.canvasctx.moveTo(p[0],p[1]),this.canvasctx.lineTo(y[0][2],y[0][3]));else if(1==r){c({x:p[2],y:p[3]},f)?(this.canvasctx.moveTo(p[2],p[3]),this.canvasctx.lineTo(y[1][0],y[1][1]),this.canvasctx.moveTo(p[2],p[3]),this.canvasctx.lineTo(y[1][2],y[1][3])):(this.canvasctx.moveTo(p[0],p[1]),this.canvasctx.lineTo(y[0][0],y[0][1]),this.canvasctx.moveTo(p[0],p[1]),this.canvasctx.lineTo(y[0][2],y[0][3]))}else this.canvasctx.moveTo(p[0],p[1]),this.canvasctx.lineTo(y[0][0],y[0][1]),this.canvasctx.moveTo(p[0],p[1]),this.canvasctx.lineTo(y[0][2],y[0][3]),this.canvasctx.moveTo(p[2],p[3]),this.canvasctx.lineTo(y[1][0],y[1][1]),this.canvasctx.moveTo(p[2],p[3]),this.canvasctx.lineTo(y[1][2],y[1][3])}else 2!=r&&0!=r||(this.canvasctx.moveTo(p[0],p[1]),this.canvasctx.lineTo(y[0][0],y[0][1]),this.canvasctx.moveTo(p[0],p[1]),this.canvasctx.lineTo(y[0][2],y[0][3])),1!=r&&0!=r||(this.canvasctx.moveTo(p[2],p[3]),this.canvasctx.lineTo(y[1][0],y[1][1]),this.canvasctx.moveTo(p[2],p[3]),this.canvasctx.lineTo(y[1][2],y[1][3]));if("needsave"==n){if(0==this.drawPolygon.length)return;var m={vx:p[0],vy:p[1],px1:2==r||0==r?y[0][0]:null,py1:2==r||0==r?y[0][1]:null,px2:2==r||0==r?y[0][2]:null,py2:2==r||0==r?y[0][3]:null},v={vx:p[2],vy:p[3],px1:1==r||0==r?y[1][0]:null,py1:1==r||0==r?y[1][1]:null,px2:1==r||0==r?y[1][2]:null,py2:1==r||0==r?y[1][3]:null};this.drawPolygon.push(m),this.drawPolygon.push(v),this.drawCanvas.dispatchEvent(this.event[0]),this.drawPolygon=[]}l&&(this.canvasctx.fillStyle=h,this.canvasctx.font="14px Arial",this.canvasctx.fillText("A",g[0],g[1]),this.canvasctx.fillText("B",g[2],g[3]),this.canvasctx.fill())},drawArrow:function(t,e,i,s,a,r){null==i&&(i.x=(t.x+e.x)/2,i.y=(t.y+e.y)/2),null==t&&null==e&&(e={},(t={}).x=0,t.y=0,e.x=0,e.y=0);var n=o(t.x,t.y,e.x,e.y,i.x,i.y,s);this.canvasctx.beginPath(),this.canvasctx.moveTo(n[4],n[5]),1==a&&(this.canvasctx.lineTo(n[4]-s/5,n[5]-s/4),this.canvasctx.lineTo(n[4]+s/5,n[5]-s/4),this.canvasctx.lineTo(n[4],n[5]),this.canvasctx.fillStyle="#0000ff"),2==a&&(this.canvasctx.lineTo(n[4]-s/5,n[5]+s/4),this.canvasctx.lineTo(n[4]+s/5,n[5]+s/4),this.canvasctx.lineTo(n[4],n[5]),this.canvasctx.fillStyle="#ff0000"),this.canvasctx.fill(),this.canvasctx.closePath()},returnCoord:function(){if(6==this.drawType)return this.gridNumArr;this.osdFrontDatas.length>0?this.osdFrontDatas:this.allPolygons;var t={};if(t=this.drawPolygon.length>0?JSON.parse(JSON.stringify(this.drawPolygon)):JSON.parse(JSON.stringify(this.osdFrontDatas[this.dragIndex].coord)),this.dragCoor=[],this.drawPolygon=[],this.canDrag){var e={index:this.dragIndex,coord:n(t,this.width,this.height),status:"drag",data:this.osdFrontDatas&&this.osdFrontDatas[this.dragIndex]};return this.dragIndex=-1,this.dragCoor=[],e}return n(t,this.width,this.height)},returnDelete:function(){return this.deleteId&&this.deleteId.coord&&(this.deleteId.coord=n(this.deleteId.coord,this.width,this.height)),this.deleteId},returnAllCoord:function(){return this.allPolygons},returnTemper:function(){return this.allPolygons},setDelete(t,e){this.isDrawing=!1,this.deleteStatus=t},destory:function(){this.removeEventListens()}};var s=[];function a(t,e,i){var a=[];s=[];for(var n=0;n<t.length;n++){var o=JSON.parse(JSON.stringify(t[n]));"Mask"==o.subtype&&s.push(o);let l=o;l.index=n,l.coord&&(l.coord=r(o.coord,e,i)),o.directCoor&&(l.directCoor=r(o.directCoor,e,i)),o.istemper&&(l.mincoord=r([o.mincoord],e,i)[0],l.maxcoord=r([o.maxcoord],e,i)[0],l.cencoord=r([o.cencoord],e,i)[0]),a.push(l)}return a}function r(t,e,i){for(var s=[],a=0;a<t.length;a++){var r=t[a],n={};for(var o in r)-1==o.indexOf("x")&&-1==o.indexOf("X")||(n[o.toLowerCase()]=null==r[o]?null:r[o]*e/8192),-1==o.indexOf("y")&&-1==o.indexOf("Y")||(n[o.toLowerCase()]=null==r[o]?null:r[o]*i/8192);s.push(n)}return s}function n(t,e,i){for(var s=[],a=0;a<t.length;a++){var r=t[a],n={};for(var o in r)-1!=o.indexOf("x")?n[o]=null==r[o]?null:r[o]/e*8192:n[o]=null==r[o]?null:r[o]/i*8192;s.push(n)}return s}function o(t,e,i,s,a,r,n,o){if(o||(o=2),a=null===a?(t+i)/2:a,r=null===r?(e+s)/2:r,i!=t)var l=(s-e)/(i-t),h=n/o*l/Math.sqrt(l*l+1),c=n/o/Math.sqrt(l*l+1);else h=n/o,c=0;return[a+h,r-c,a-h,r+c,a,r]}function h(t,e,i,s){var a=e.y-t.y,r=t.x-e.x,n=s.y-i.y,o=i.x-s.x,l=a*o-r*n;if(0==l)return!1;var h=n*i.x+o*i.y,c=n*t.x+o*t.y-h;if(c*(n*e.x+o*e.y-h)>=0)return!1;var d=a*t.x+r*t.y;if((a*i.x+r*i.y-d)*(a*s.x+r*s.y-d)>=0)return!1;var u=c/l,f=u*r,p=-u*a;return{x:t.x+f,y:t.y+p}}function c(t,e){var i=t.x,s=t.y,a=!1;if(e.length<=1)return!1;e=function(t){for(var e=[],i=0;i<t.length;i++){var s=t[i];if(0==e.length)e.push(s);else{var a=e[e.length-1];a.x==s.x?a.y<s.y?e.splice(e.length-1,0,s):e.push(s):a.y==s.y&&a.x<s.x?e.splice(e.length-1,0,s):e.push(s)}}return e}(e);for(var r=0,n=e.length,o=n-1;r<n;o=r,r++){var l=e[r].x,h=e[r].y,c=e[o].x,d=e[o].y;if(l===i&&h===s||c===i&&d===s)return!0;if(h<s&&d>=s||h>=s&&d<s){var u=l+(s-h)*(c-l)/(d-h);if(u===i)return!0;u>i&&(a=!a)}}return a}function d(t,e,i,s,a,r,n,o){return Math.min(t,i)<=Math.max(a,n)&&Math.min(r,o)<=Math.max(e,s)&&Math.min(a,n)<=Math.max(t,i)&&Math.min(e,s)<=Math.max(r,o)&&(((a-t)*(s-e)-(i-t)*(r-e))*((n-t)*(s-e)-(i-t)*(o-e))<=1e-8&&((t-a)*(o-r)-(n-a)*(e-r))*((i-a)*(o-r)-(n-a)*(s-r))<=1e-8)}function u(t,e){var i=t.width,s=t.height,a=t.getBoundingClientRect().width,r=t.getBoundingClientRect().height,n=t.getBoundingClientRect().left,o=t.getBoundingClientRect().top,l=e.clientX-n,h=e.clientY-o;return[parseInt(l*i/a),parseInt(h*s/r)]}var f=function(t,e,s){var a=[],r=[],n=null,o=null,l=null,h=!1,c=!1,d=!1,u=!1,f=!1,p=null,g=0,y=s.skip_loopfilter,m=null,v=null,x=null,w=null,T=!1,S=!1,C={},P=t,A=e,b=s,R=null,D=null,k=0,F=[],E=null,I=4,N=1,M=65,L={username:s.username,password:s.password},B=null,U=null,O=null,W=null,_="Options",G="",$="",q=!1,V={},z={},J={},X=!1,Y=!1,H=!1,j=!1;function K(){}function Q(t,e,i,s,a){var r="";$="User-Agent: SFRtsp 0.3";var n="";if(a&&a.Type){var o=10*a.params.Scale;a.params.Scale||(o=1),n=`Range: npt=${a.params.Timestamp}\r\nScale: ${o}\r\nStartTime: ${a.params.StartTime}\r\nEndTime: ${a.params.EndTime}\r\nAuthorization: ${L.username}|${L.password}`}switch(t){case"OPTIONS":r=`${t} * RTSP/1.0\r\nCSeq: ${+z.headers.cseq+1}\r\n${$}\r\n\r\n`;break;case"SET_PARAMETERS":r=t+" "+A+" RTSP/1.0\r\nCSeq: "+(+z.headers.cseq+1)+"\r\n"+$+"\r\n\r\n";break;case"TEARDOWN":case"GET_PARAMETER":case"PAUSE":r=t+" "+A+" RTSP/1.0\r\nCSeq: "+(+z.headers.cseq+1)+"\r\nSession: "+z.headers.session+"\r\n\r\n";break;case"DESCRIBE":r=`${t} ${A} RTSP/1.0\r\nAccept: application/sdp\r\nCSeq: ${+z.headers.cseq+1}\r\n${$}\r\n${n}\r\n\r\n`;break;case"SETUP":let e="";if(-1!=A.indexOf("?track=")){e=A.split("?track=")[0]+"/track_video"}else e=A+"/track_video";r=`${t} ${e} RTSP/1.0\r\nTransport: RTP/AVP/TCP;unicast;interleaved=0-1\r\nCSeq: ${+z.headers.cseq+1}\r\n${$}\r\n${n}\r\n\r\n`;break;case"PLAY":r=`${t} ${A} RTSP/1.0\r\nSession: ${z.headers.session}\r\nCSeq: ${+z.headers.cseq+1}\r\n${$}\r\n${n}\r\n\r\n`;break;case"SCALE":r="PLAY "+A+" RTSP/1.0\r\nCSeq: "+(+z.headers.cseq+1)+"\r\nSession: "+z.headers.session+"\r\n",r+="Scale: "+s+"\r\n",r+=$+"\r\n\r\n"}return r=`WSP/1.1 WRAP\r\ncontentLength: ${r.length}\r\nseq: ${+V.data.seq+1}\r\n\r\n`+r}function Z(t,e){var i=L.username,a=L.password,r={Method:null,Realm:null,Nonce:null,Uri:null};let n=t["www-authenticate"];if(console.log('typestr.search("Basic")',n.search("Basic")),n.search("Basic")>=0){console.log(encodeURI(i+":"+a));let t=btoa(encodeURI(i+":"+a));$="Authorization: Basic "+t,$+="\r\n"}else if(n.search("Digest")>=0){let t=n.search("Digest realm=")+14,e=t+18,s=n.substring(t,e),o=n.search("nonce=")+7,l=o+32,h=n.substring(o,l);r={Method:_.toUpperCase(),Realm:s,Nonce:h,Uri:"SETUP"==_.toUpperCase()?A+"/track_video":A},console.log(i,a),respontxt=function(t,e,i,s,a,r){var n=null,o=null,l=null;return n=md5(t+":"+s+":"+e).toLowerCase(),o=md5(r+":"+i).toLowerCase(),l=md5(n+":"+a+":"+o).toLowerCase(),l}(i,a,r.Uri,r.Realm,r.Nonce,r.Method),$='Authorization: Digest username="'+i+'", realm="'+r.Realm+'",',$+=' nonce="'+r.Nonce+'", uri="'+r.Uri+'", response="'+respontxt+'"',$+="\r\n"}e&&tt(Q(_.toUpperCase(),0,0,s))}function tt(t){if(null!=t&&null!=t&&""!=t)if(null!==R&&R.readyState===WebSocket.OPEN){if(!1===q)-1!==t.search("DESCRIBE")&&(q=!0);null!=t&&R.send(et(t))}else Dt(),console.log("ws未连接")}function et(t){for(var e=t.length,i=new Uint8Array(new ArrayBuffer(e)),s=0;e>s;s++)i[s]=t.charCodeAt(s);return t}function it(t,e){var i=new Buffer(t.length+e.length);return i.set(t,0),i.set(e,t.length),i}function st(t){let e=t.indexOf("\r\n\r\n"),i=t.substr(0,e).split("\r\n"),s=i.shift().match(new RegExp("WSP/1.1\\s+(\\d+)\\s+(.+)"));if(s){let a={code:Number(s[1]),msg:s[2],data:{},payload:""};for(;i.length;){let t=i.shift();if(!t)break;{let[e,i]=t.split(":");a.data[e.trim()]=i.trim()}}return a.payload=t.substr(e+4),a}return null}function at(t){let e=function(t){let e,i=t.split("\r\n"),s={headers:{},body:null,code:0,statusLine:""};[e,s.code,s.statusLine]=i[0].match(new RegExp("1.0[ ]+([0-9]{3})[ ]+(.*)")),s.code=Number(s.code);let a=1;for(;i[a];){let[t,e]=i[a].split(/:(.+)/);s.headers[t.toLowerCase()]=e.trim(),a++}return s.body=i.slice(a).join("\n\r"),s}(t.payload.split("\r\n\r\n")[0]);if(Number(e.headers["content-length"])){let i=t.payload.split("\r\n\r\n");e.body=i[1]}else e.body="";return e}var rt=[],nt=[];function ot(t,e){if("string"==typeof t.data){let e=st(t.data);if(V=st(t.data),e.data.seq==M){(D=new WebSocket(P,"data")).binaryType="arraybuffer",D.addEventListener("message",lt,!1),D.onopen=function(){var t=et(`WSP/1.1 JOIN\r\nchannel: ${e.data.channel} \r\nseq: ${+e.data.seq+1}\r\n\r\n`);D.send(t)}}else{if(401==(z=at(e)).code)return void Z(z.headers,!0);let t=z.headers["www-authenticate"];"Options"===_?(_="Describe",t&&t.search("nonce=")>=0&&Z(z.headers,!1),tt(Q("DESCRIBE",0,0,null,s))):"Describe"===_?(_="Setup",t&&t.search("nonce=")>=0&&Z(z.headers,!1),tt(Q("SETUP",0,0,null))):"Setup"===_&&(_="Play",t&&t.search("nonce=")>=0&&Z(z.headers,!1),tt(Q("PLAY",0,0,null,s)),clearInterval(E),E=setInterval((()=>{_="Playing",tt(Q("OPTIONS",0,0,null))}),3e4))}}}function lt(t){if(S=!0,"string"==typeof t.data){if(+(J=st(t.data)).data.seq==M+1){let t=et(`WSP/1.1 WRAP\r\ncontentLength: 86\r\nseq: ${+J.data.seq+1}\r\n\r\nOPTIONS ${A} RTSP/1.0\r\nCSeq: 1\r\nUser-Agent: SFRtsp 0.3\r\n\r\n`);R.send(t)}}else{var e=new Uint8Array,i=new Uint8Array(t.data);(e=new Uint8Array(i.length)).set(i,0),rt.length&&(e=it(rt,e),rt=[]);for(let t=0;t<e.length;t++)if(80==e[t]&&82==e[t+1]&&65==e[t+2]&&86==e[t+3]){var s=e[t+15]<<24|e[t+14]<<16|e[t+13]<<8|e[t+12];if(e.length<s)rt=e;else wt(e.subarray(t,t+s)),e=e.subarray(t+s),rt=e;break}}}function ht(t,e){if(0===arguments.length)return null;const i=e||"{y}-{m}-{d} {h}:{i}:{s}";let s;"object"==typeof t?s=t:(10===(""+t).length&&(t=1e3*parseInt(t)),s=new Date(t));const a={y:s.getFullYear(),m:s.getMonth()+1,d:s.getDate(),h:s.getHours(),i:s.getMinutes(),s:s.getSeconds(),a:s.getDay()};return i.replace(/{(y|m|d|h|i|s|a)+}/g,((t,e)=>{let i=a[e];return"a"===e?["日","一","二","三","四","五","六"][i]:(t.length>0&&i<10&&(i="0"+i),i||0)}))}var ct=[],dt=[],ut=[],ft={},pt=[];function gt(t,e){let i=[];if("ivs"==e)for(var s in t)if("Face"==s){if(t[s])for(var a=0;a<t[s].length;a++){var r={type:4,id:(n=t[s][a]).ID,name:null,color:n.Color,directBool:!1,directText:!1,direct:0,coord:[{x:n.Rect.Left,y:n.Rect.Top},{x:n.Rect.Right,y:n.Rect.Bottom}],hasHTem:!1,hasLTem:!1,position:[{x:n.Rect.Left,y:n.Rect.Top},{x:n.Rect.Right,y:n.Rect.Bottom}],time:ht(n.TimeStamp)};i.push(r)}}else if(("Person"==s||"NonMotorVehicle"==s||"MotorVehicle"==s||"Tricycle"==s||"Alert"==s)&&t[s])for(a=0;a<t[s].length;a++){var n;r={type:4,id:(n=t[s][a]).ID,name:null,color:n.Color,directBool:!1,directText:!1,direct:0,coord:[{x:n.Rect.Left,y:n.Rect.Top},{x:n.Rect.Right,y:n.Rect.Bottom}],hasHTem:!1,hasLTem:!1,position:[{x:n.Rect.Left,y:n.Rect.Top},{x:n.Rect.Right,y:n.Rect.Bottom}],time:ht(n.TimeStamp)};i.push(r)}return i}var yt=[];function mt(t,i,s){var a=0,r=yt,n={RGBA:[255,0,0,1]},o=setInterval((()=>{for(var l=s,h=i,c=t,d=-1,u=-1,f=0;f<r.length;f++)r[f].istemper&&"temper"==i.split("-")[0]&&r[f].type==i.split("-")[1]&&r[f].id==i.split("-")[2]&&(c=f,r[f].color=a%2?n:yt[f]&&yt[f].color?yt[f].color:{RGBA:[255,255,255,1]}),r[f].isivs&&"ivs"==i.split("-")[0]&&r[f].type-1==i.split("-")[1]&&r[f].id==i.split("-")[2]&&(r[f].color=a%2?n:yt[f]&&yt[f].color?yt[f].color:{RGBA:[255,255,255,1]}),r[f].isfire&&r[f].alarmData.Index==i.split("-")[1]&&r[f].alarmData.Index==i.split("-")[1]&&(r[f].color=a%2?n:{RGBA:[255,255,255,1]},d=f),r[f].isDynamic&&r[f].alarmData.ID==i.split("-")[1]&&r[f].alarmData.ID==i.split("-")[1]&&(r[f].color=a%2?n:{RGBA:[255,255,255,1]},u=f);(a++,"temper"==l&&1==a&&r[c].istemper)&&((y=r[c]).EventTime=p,O(y));if("fire"==l&&1==a){var g=r[d].alarmData.ID-1,y={index:c,txt:ft[g]};B(y)}if("dynamic"==l&&1==a){var m=r[u].alarmData.ID-1;y={index:c,txt:(-1!=e.indexOf("channel=0")?1:2)+":"+pt[m].Name};U(y)}if(20==a){ut.splice(ut.indexOf(h),1);for(var v=ct.length-1;v>=0;v--)if(ct[v].drawName==h){ct.splice(v,1),yt.splice(c,1);break}clearInterval(o)}w.showallPolygons(r)}),80)}var vt=!1,xt=!1;p=0;function wt(t,i,s){var a=t[5],r=t[15]<<24|t[14]<<16|t[13]<<8|t[12],n=28,o=t[25]<<8|t[24],l=t.subarray(n+o,r-8);if(t.subarray(0,I),3==(x=v.getState())||1==x){if(240==a&&c){var g=t.subarray(n,n+o);h||St(g,"audio"),3!=(x=v.getState())&&1!=x||-1!=e.indexOf("channel=0")&&v&&v.putAudioData(l)}if(240==a&&d){g=t.subarray(n,n+o);h||St(g,"audio"),3!=(x=v.getState())&&1!=x||-1!=e.indexOf("vod")&&v&&v.putAudioData(l)}if(240==a&&u&&"isTalk"==s){g=t.subarray(n,n+o);h||St(g,"audio"),3!=(x=v.getState())&&1!=x||-1!=e.indexOf("channel=0")&&v&&v.putAudioData(l)}if(253==a||254==a||252==a||251==a){var m=t[11]<<24|t[10]<<16|t[9]<<8|t[8];e.indexOf("channel=1");g=t.subarray(n,n+o);h||St(g,"video");var x=v.getState();vt?3!=x&&1!=x||v&&v.putData(l,y,m):253==a&&(3!=x&&1!=x||(v&&v.putData(l,y,m),vt=!0)),1==k?(xt||(xt=!0,v.startRecord((function(t){!function(t){console.log("%c [ data ]-1976","font-size:13px; background:#4d441e; color:#918862;",t);let i=new Blob([t],{type:"application/octet-stream"}),s=window.URL.createObjectURL(i),a=document.createElement("a");var r="Visible";-1!=e.indexOf("channel=1")&&(r="Thermal");var n=r+"_"+At(new Date);a.href=s,a.download=n+".h265",a.click()}(t)}))),F=it(F,l)):2==k&&(console.log("%c [ recordBinary1 ]","font-size:13px; background:pink; color:#bf2c9f;",F),xt=!1,k=0,v.stopRecord())}var w=t[18]<<16|t[17]<<8|t[16],T=t[20]*Math.pow(2,32),S=t[21]*Math.pow(2,40),C=t[19]*Math.pow(2,24),P=new Date(w+T+S+C);if(p!=P&&(p=P,f)){let t=e.split("/");t[t.length-1].split("_")[0]}}}var Tt=!1;function St(t,e){a=[];for(var i=0;i<t.length;i++){var s=t[i],r=t[i+3]<<8|t[i+2];Pt(s,t.subarray(i+4,i+r)),i=i+r-1}"audio"!=e&&Promise.all(a).then((function(t){var i=[];Tt&&0==t.length&&"video"==e&&(Tt=!1,w.clearCanvas()),t.length>0&&"video"==e&&(Tt=!0);for(var s=0;s<t.length;s++){var a=gt(t[s].data,t[s].type);i=[...i,...a]}T&&i.push(C),dt=JSON.parse(JSON.stringify(i)),i.length>0&&0==ct.length?w.showallPolygons(i):ct.length>0&&function(){if(0!=ct.length){yt=JSON.parse(JSON.stringify(dt));for(var t=0;t<ct.length;t++){var e=ct[t];if("fire"==e.showtype){if(-1==ut.indexOf(e.drawName)){ut.push(e.drawName),(s={type:4,directBool:!1,isivs:!1,istemper:!1,isfire:!0,isDynamic:!1,color:{RGBA:[255,0,0,1]}}).alarmData=e.alarmData;var i=e.alarmData;s.coord=[{x:i.Rect.Left,y:i.Rect.Top},{x:i.Rect.Right,y:i.Rect.Bottom}],yt.push(s),mt(yt.length,e.drawName,"fire")}}else if("dynamic"==e.showtype){if(-1==ut.indexOf(e.drawName)){var s;ut.push(e.drawName),(s={type:4,directBool:!1,isivs:!1,istemper:!1,isfire:!1,isDynamic:!0,color:{RGBA:[255,0,0,1]}}).alarmData=e.alarmData,i=pt[e.alarmData.ID-1],s.coord=[{x:i.Region.Left,y:i.Region.Top},{x:i.Region.Right,y:i.Region.Bottom}],yt.push(s),mt(yt.length,e.drawName,"dynamic")}}else if("temper"==e.showtype)-1==ut.indexOf(e.drawName)&&(ut.push(e.drawName),mt(e.drawIndex,e.drawName,"temper"));else{var a=dt[e.drawIndex];(2==a.type&&1==e.alarmData.RuleType||3==a.type&&2==e.alarmData.RuleType)&&a.id==e.alarmData.RuleID&&a.isivs&&-1==ut.indexOf(e.drawName)&&(ut.push(e.drawName),mt(e.drawIndex,e.drawName,"ivs"))}}}}(),0==i.length&&0==ct.length&&w.clearCanvas()})).catch((t=>{}))}function Ct(){vt=!1,Rt(),o=null,l=null,r=[],n=null,bt()}function Pt(t,i){switch(e.indexOf("channel=0"),t){case 128:var s=i[5]<<8|i[4],h=i[7]<<8|i[6];0==r.length?(r.push(s),r.push(h)):(e.indexOf("channel=0"),r[0]==s&&r[1]==h||(r[0]=s,r[1]=h,Ct()));break;case 129:t=i[1];null==n?n=t:n!=t&&(n=t,Ct());break;case 130:t=i[2];var c=i[3];null===o&&null===l&&(o=t,l=c,v&&v.setAudioFormat(c,t)),null===o||null===l||o==t&&l==c||(o=t,l=c,Ct());break;case 131:break;case 144:case 145:case 146:case 147:if(144==t){var d=new Uint8Array(i),u=new Blob([d]);(g=new FileReader).readAsText(u,"utf-8");var f=new Promise((function(t,e){g.onload=function(){if(g.result){var i={data:JSON.parse(g.result),type:"ivs"};t(i)}else e()}}));a.push(f)}if(Y&&145==t){d=new Uint8Array(i),u=new Blob([d]);(g=new FileReader).readAsText(u,"utf-8");var p=new Promise((function(t,e){g.onload=function(){if(g.result){var i={data:JSON.parse(g.result),type:"temper"};i.data.Events,t(i)}else e()}}));a.push(p)}if(H&&146==t){d=new Uint8Array(i),u=new Blob([d]);(g=new FileReader).readAsText(u,"utf-8");p=new Promise((function(t,e){g.onload=function(){if(g.result){for(var i={data:JSON.parse(g.result),type:"fire"},s=[],a=0,r=i.data.Events.length;a<r;a++)0==i.data.Events[a].Rect.Left&&0==i.data.Events[a].Rect.Top&&0==i.data.Events[a].Rect.Right&&0==i.data.Events[a].Rect.Bottom||s.push(i.data.Events[a]);i.data.Events=s,s.length>0&&t(i)}else e()}}));a.push(p)}if(147==t){d=new Uint8Array(i),u=new Blob([d]);(g=new FileReader).readAsText(u,"utf-8");p=new Promise((function(t,e){g.onload=function(){if(g.result){var i={data:JSON.parse(g.result),type:"facetemper"};t(i)}else e()}}));a.push(p)}break;case 148:if(j){var g;d=new Uint8Array(i),u=new Blob([d]);(g=new FileReader).readAsText(u,"utf-8");f=new Promise((function(t,e){g.onload=function(){if(g.result){var i={data:JSON.parse(g.result),type:"dynamic"};t(i)}else e()}}));a.push(f)}}}function At(t){return t.getFullYear()+""+(t.getMonth()+1<10?"0"+(t.getMonth()+1):t.getMonth()+1)+(t.getDate()<10?"0"+t.getDate():t.getDate())+(t.getHours()>=10?t.getHours():"0"+t.getHours())+(t.getMinutes()>=10?t.getMinutes():"0"+t.getMinutes())+(t.getSeconds()>=10?t.getSeconds():"0"+t.getSeconds())}function it(t,e){var i=new Uint8Array(t.length+e.length);return i.set(t,0),i.set(e,t.length),i}function bt(){var t=v.getState();if(0==t)v.play(null,m,(function(t){0==t.error&&(issuccessedPlay=!0),1==t.error&&logger.logInfo("Finished.")}),0,g,1);else{if(1==t||3==t)return;setTimeout((()=>{bt()}),100)}}function Rt(t){var e=v.getState();if(1==e)v.stop(t);else{if(0==e)return;setTimeout((()=>{Rt()}),500)}vt=!1}function Dt(){console.log("[ 重连ws ]"),N=1,_="Options";let t=window.sessionStorage.getItem("token");if(-1!=P.indexOf("x-token"))var e=P.match(/(\S*)x-token/)[1]+"x-token="+t;else e=P;if(-1==e.indexOf("vod-pav")){var i=e.split(":")[1].slice(2),s=e.split(":")[2].split("/")[0];R=null,D&&D.close(),D=null,R=new WebSocket(e,"control"),clearInterval(E),E=null,R.binaryType="arraybuffer",R.addEventListener("message",ot,!1),R.onopen=function(){var t=et(`WSP/1.1 GET_INFO\r\nproto: rtsp\r\nhost: ${i}\r\nport: ${s}\r\nclient: \r\nseq: ${M}\r\n\r\n`);R.send(t);var e=et(`WSP/1.1 INIT\r\nproto: rtsp\r\nhost: ${i}\r\nport: ${s}\r\nclient: \r\nseq: ${M}\r\n\r\n`);R.send(e)},R.onclose=function(t){console.log("===webSocket重连断开222！"),console.log("%c [ err ]","font-size:13px; background:pink; color:#bf2c9f;",e),console.log("%c [ err ]","font-size:13px; background:pink; color:#bf2c9f;",t.code),window.sessionStorage.getItem("token")?(R=null,W(!0)):(clearInterval(E),E=null),S&&setTimeout((()=>{Dt()}),5e3)},R.onerror=function(t){console.log("%c [ ws错误 ]","font-size:13px; background:pink; color:#bf2c9f;",t),window.sessionStorage.getItem("token")?(R=null,W(!0)):(clearInterval(E),E=null),setTimeout((()=>{Dt()}),5e3)}}}return K.prototype={init:function(t,e,i,s,a){m=t,g=a,v=i},openWs:function(){var t=et("OPTIONS "+A+" RTSP/1.0\r\nCSeq: "+N+"\r\n\r\n");R.send(t);setInterval((function(){R.send("heartbeat")}),6e4)},connect:function(){if(console.log("[ 11111 ] >"),R&&R.close(),S=!1,!(R=null)){let s=window.sessionStorage.getItem("token");if(-1!=P.indexOf("x-token"))var t=P.match(/(\S*)x-token/)[1]+"x-token="+s;else t=P;var e=t.split(":")[1].slice(2),i=t.split(":")[2].split("/")[0];(R=new WebSocket(t,"control")).binaryType="arraybuffer",R.addEventListener("message",ot,!1),b&&"playback"==b.type?R.onopen=function(){var t=et(`WSP/1.1 GET_INFO\r\nChn:${b.Chn}\r\nStartTime: ${b.StartTime}\r\nEndTime: ${b.EndTime}\r\nseq: ${M}\r\n\r\n`);R.send(t);var e=et(`WSP/1.1 INIT\r\nChn:${b.Chn}\r\nStartTime: ${b.StartTime}\r\nEndTime: ${b.EndTime}\r\nseq: ${M}\r\n\r\n`);R.send(e)}:R.onopen=function(){var t=et(`WSP/1.1 GET_INFO\r\nproto: rtsp\r\nhost: ${e}\r\nport: ${i}\r\nclient: \r\nseq: ${M}\r\n\r\n`);R.send(t);var s=et(`WSP/1.1 INIT\r\nproto: rtsp\r\nhost: ${e}\r\nport: ${i}\r\nclient: \r\nseq: ${M}\r\n\r\n`);R.send(s)},R.onclose=function(t){console.log("===webSocket 连接断开了111！"),console.log("%c [ err ]","font-size:13px; background:pink; color:#bf2c9f;",t),console.log("%c [ err ]","font-size:13px; background:pink; color:#bf2c9f;",t.code),window.sessionStorage.getItem("token")?(R=null,W(!0)):(clearInterval(E),E=null),S&&Dt()},R.onerror=function(t){console.log("%c [ ws错误 ]","font-size:13px; background:pink; color:#bf2c9f;",t),window.sessionStorage.getItem("token")?(R=null,W(!0)):(clearInterval(E),E=null),Dt()}}},disconnect:function(t){null!=R&&tt(Q("PAUSE")),setTimeout((()=>{S=!1}),1e3),vt=!1,clearInterval(E),E=null,null!==R&&R.readyState==WebSocket.OPEN&&(R=null)},onlyStopMfPlayer:function(t){"mf"==EncodeMode&&(Rt(!0),vt=!1)},resetWsReqE:function(){_="Options"},pauseandteardown:function(){clearInterval(E),E=null,tt(Q("PAUSE")),tt(Q("TEARDOWN"))},controlPlayer:function(t){var e="";switch(G=t.command,t.command){case"PLAY":if(_="Play",null!=t.range){e=Q("PLAY",0,0,t.range);break}e=Q("PLAY"),"mf"==EncodeMode||G&&x.initStartTime();break;case"PAUSE":if("PAUSE"===_)break;_="PAUSE",e=Q("PAUSE");break;case"SCALE":e=Q("SCALE",0,0,t.data),"mf"==EncodeMode||x.playbackSpeed(t.data);break;case"TEARDOWN":e=Q("TEARDOWN");break;case"audioPlay":case"volumn":case"audioSamplingRate":"mf"==EncodeMode||x.controlAudio(t.command,t.data);break;default:console.log("未知指令: "+t.command)}""!=e&&tt(e)},playseek(t){tt(Q("PLAY",0,0,null,t))},setLiveMode:function(t){"mf"==EncodeMode||x.setLiveMode(t)},setRTSPURL:function(t){A=t},onRecord:function(t){k=t},onRecordRaw:function(t){1==t&&(F=[])},onRecordVoice:function(t){},setCallback:function(t,e){"GetFiretip"===t&&(B=e),"GetDynamictip"===t&&(U=e),"GetTempertip"===t&&(O=e),"websocketclose"===t&&(W=e)},setUserInfo:function(t,e){t.username=t,t.password=e},capture:function(t){var e=this;"yj"==EncodeMode&&x.capture(t),"mf"==EncodeMode&&v.snapPicture((function(t){e.savePicture(t)}))},savePicture:function(t){let e=new Blob([t],{type:"image/jpg"}),i=window.URL.createObjectURL(e),s=document.createElement("a");var a="pic_"+At(new Date);s.href=i,s.download=a+".jpg",s.click()},resizeCanvas:function(t,e){"yj"==EncodeMode&&x.resizeCanvas(t,e)},showIVS:function(t,e,i){X=e,this.addOSDAPI(t,i)},showTemper:function(t,e,i){Y=e,this.addOSDAPI(t,i)},showFire:function(t,e,i){H=e,this.addOSDAPI(t,i)},showDynamic:function(t,e,i){j=e,this.addOSDAPI(t,i)},showFaceArea:function(t,e,i,s){T=e,C=s,this.addOSDAPI(t,i)},addOSDAPI:function(t,e){null==w?(X||Y||H||j||T)&&(w=new i).init(t,!0,"#FFFF00","#FF9900",!1,!1,e,!1,"intell"):X||Y||j||0!=e&&(1!=e||H)||w&&(w.close(),w=null)},removeOSDAPI:function(){w&&(w.close(),w=null)},digitalZoom:function(t){x.digitalZoom(t)},isPlayback:function(t){f=t,t||w&&(w.close(),w=null)},freeze:function(t){h=t},setVoice:function(t){(c=t)||(o=null,l=null)},setPBVoice:function(t){(d=t)||(o=null,l=null)},setTalk:function(t){t!=u&&((u=t)||(o=null,l=null))},sendTalkData:function(t){!function(t,e){var i=new Uint8Array,s=new Uint8Array(t.data);if((i=new Uint8Array(s.length)).set(s,0),82==i[0]&&84==i[1]&&83==i[2]&&80==i[3]);else{nt.length&&(i=it(nt,i),nt=[]);for(let t=0;t<i.length;t++)if(80==i[t]&&82==i[t+1]&&65==i[t+2]&&86==i[t+3]){var a=i[t+15]<<24|i[t+14]<<16|i[t+13]<<8|i[t+12];i.length<a||(wt(i.subarray(t,t+a),0,e),i=i.subarray(t+a)),nt=i;break}}}(t,"isTalk")},changeRuleCoord:function(t){(new Date).getTime()}},new K};const p=function(t){this.player=null,this.currentState="",this.canvasW=null,this.opt=t,this.setsubtime=0,this.beforesub=-1,this.cansetsubtype=!0,this.canChange=!1,this.wsURL=t&&t.wsURL,this.rtspURL=t&&t.rtspURL,this.ws=null,this.subtype=t&&t.subtype,this.root=document.getElementById(t.root),this.decodeMode=t&&t.decodeMode,this.isPlaying=0,this.isRecord=0,this.largeStatus=0,this.fullscreen=t&&t.fullScreen,this.curCanvasDiv=null,this.beforeFullSta=!1,this.decoderWaitBytes=65536,this.decode_interval=20,this.needseek=t&&t.needseek?t.needseek:0,this.events={ResolutionChanged:function(){},PlayStart:function(){},DecodeStart:function(){},UpdateCanvas:function(){},GetFrameRate:function(){},FrameTypeChange:function(){},Error:function(){},MSEResolutionChanged:function(){},audioChange:function(){},WorkerReady:function(){},IvsDraw:function(){},FileOver:function(){}},this.username=t.username,this.password=t.password};function g(t){console.log(t),this.gl=t,this.texture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this.texture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE)}function y(t,e){this.canvas=t,this.gl=t.getContext("webgl")||t.getContext("experimental-webgl")||t.getContext("webkit-3d")||t.getContext("moz-webgl"),this.initGL(e)}p.prototype={init:function(t,e,i,s){console.log("-----------init-----"),this.canvasW=t||this.canvasW,this.opt=s,this.player=e,s&&(this.wsURL=s.wsURL,this.rtspURL=s.rtspURL,this.needseek=s.needseek,this.subtype=s.subtype),null!=this.subtype&&this.subtype,this.ws=new f(this.wsURL,this.rtspURL,this.opt),this.ws.init(this.canvasW,i,this.player,this.decoderWaitBytes,this.decode_interval)},setUserInfo(t,e){this.ws.setUserInfo(t,e)},openTalk(){this.ws.setTalk(!0)},closeTalk(){this.ws.setTalk(!1)},sendTalkData(t){this.ws.sendTalkData(t)},sendSpeak(t){},setVoice(t){this.ws&&this.ws.setVoice(t)},setPBVoice(t){this.ws&&this.ws.setPBVoice(t)},judgeCanOpt:function(t){return this.canChange=!1,this.setsubtime?(new Date).getTime()-this.setsubtime>=2e3&&(this.canChange=!0,this.setsubtime=(new Date).getTime()):(this.setsubtime=(new Date).getTime(),this.canChange=!0),this.canChange&&1!=this.player.getState()&&(this.canChange=!1),this.canChange},setSubtype:function(t,e){this.setsubtime?(new Date).getTime()-this.setsubtime>=2e3&&(this.canChange=!0,this.setsubtime=(new Date).getTime()):(this.setsubtime=(new Date).getTime(),this.canChange=!0),this.canChange&&(this.subtype!=t?this.canChange=!0:this.canChange=!!e),this.canChange&&1!=this.player.getState()&&(this.canChange=!1),this.canChange&&(this.ws.disconnect(!0),this.closedPlayer(!1),this.subtype=t,this.init(this.canvasW,this.player,null,this.opt),this.connect())},changeChannel:function(t){this.wsURL=t.wsURL,this.rtspURL=t.rtspURL,this.opt.wsURL=t.wsURL,this.opt.rtspURL=t.rtspURL,this.opt.skip_loopfilter=t.skip_loopfilter,this.ws.disconnect(!0),this.closedPlayer(!1),setTimeout((()=>{this.init(this.canvasW,this.player,null,this.opt),this.connect()}),500)},resetPlay(){this.ws.disconnect(!0),this.closedPlayer(!1),this.init(this.canvasW,this.player,null,this.opt),this.connect()},closedPlayer(t){var e=this.player.getState();1==e||3==e?this.player.stop(t):setTimeout((()=>{0!=e&&this.closedPlayer(t)}),500)},openPlayer(){var t=this.player.getState();0==t?this.player.play(null,this.canvasW,(function(t){t.error,1==t.error&&logger.logInfo("Finished.")}),0,this.decode_interval,1):setTimeout((()=>{1!=t&&3!=t&&this.openPlayer()}),500)},setCallback(t,e){"canSetSubtype"===t||this.ws.setCallback(t,e)},screen:function(t){!function(t){for(var e=t.childNodes,i=0;i<e.length;i++)1!==e[i].nodeType&&t.removeChild(e[i])}(this.root);this.compuScreen(this.root,t,[16/9,4/3])},connect:function(){this.ws.connect(),this.openPlayer(),this.isPlaying=1},connect1:function(){this.ws.connect()},play:function(t){this.controlPlayer("PLAY"),this.isPlaying=1},isPlayback(t){this.ws.isPlayback(t)},removeOSDAPI(){this.ws.removeOSDAPI()},playseek(t){this.ws.playseek(t)},getPlayStatus:function(){return this.player.getState()},getPlaybacktime:function(){return this.ws.getPlaytime()},pause:function(t){this.ws.pauseandteardown(),this.closedPlayer(t)},closeplayer:function(t){this.ws.onlyStopMfPlayer(t)},wsclose:function(){this.ws.resetWsReqE()},stop:function(){},close:function(){try{this.ws.disconnect(),this.closedPlayer(!0)}catch(t){}},destroy:function(){this.ws.disconnect(),this.closedPlayer(!0),this.player.destroy()},playByTime:function(t){this.controlPlayer("PLAY","video",t)},playFF:function(t){this.controlPlayer("PAUSE"),this.controlPlayer("SCALE",t)},playRewind:function(){},audioPlay:function(){this.controlPlayer("audioPlay","start")},audioStop:function(){this.controlPlayer("audioPlay","stop")},setAudioSamplingRate:function(t){this.controlPlayer("audioSamplingRate",t)},setAudioVolume:function(t){this.controlPlayer("volumn",t)},controlPlayer:function(t,e,i){var s;s="video"===e?{command:t,range:i||0}:{command:t,data:e},this.ws.controlPlayer(s)},setPlayMode:function(t){this.ws.setLiveMode(t)},setPlayPath:function(t){this.ws.setRTSPURL(t)},capture:function(t){this.ws.capture(t)},freeze:function(t){this.player&&this.player.freeze(t),this.ws.freeze(t)},enlarge:function(t,e){this.player.enlarge(t,e)},on:function(t,e){this.events[t]=e},resizeCanvas:function(t,e){"yj"==EncodeMode&&this.ws.resizeCanvas(t,e)},digitalZoom:function(t){this.ws.digitalZoom(t)},showIVS:function(t,e,i){this.ws&&this.ws.showIVS(t,e,i)},showTemper:function(t,e,i){this.ws.showTemper(t,e,i)},showFire:function(t,e,i){this.ws.showFire(t,e,i)},showDynamic:function(t,e,i){this.ws.showDynamic(t,e,i)},showFaceArea:function(t,e,i,s){this.ws.showFaceArea(t,e,i,s)},onRecord:function(t){this.ws.onRecord(t)},onRecordRaw:function(t){this.ws.onRecordRaw(t)},onRecordVoice:function(t){this.ws.onRecordVoice(t)},hideweb:function(t){this.player&&this.player.hide(t)},changeImageSize(){this.closedPlayer(),this.openPlayer()},localPlayBack:function(t){var e=document.getElementById(t).files,i=new FileReader;i.readAsArrayBuffer(e[0]),i.onload=function(t){var e=new Uint8Array,i=new Uint8Array(t.target.result);(e=new Uint8Array(i.length)).set(i,0);var s=0;const a=16384;var r=setInterval((function(){if(s<=e.length-a){var t=e.subarray(s,s+a);myself.ws.localPlayback(t),s+=a}else clearInterval(r)}),20)}},changeRuleCoord(t){this.ws.changeRuleCoord(t)}},g.prototype.bind=function(t,e,i){var s=this.gl;s.activeTexture([s.TEXTURE0,s.TEXTURE1,s.TEXTURE2][t]),s.bindTexture(s.TEXTURE_2D,this.texture),s.uniform1i(s.getUniformLocation(e,i),t)},g.prototype.fill=function(t,e,i){var s=this.gl;s.bindTexture(s.TEXTURE_2D,this.texture),s.texImage2D(s.TEXTURE_2D,0,s.LUMINANCE,t,e,0,s.LUMINANCE,s.UNSIGNED_BYTE,i)},y.prototype.initGL=function(t){if(this.gl){var e=this.gl;e.pixelStorei(e.UNPACK_ALIGNMENT,1);var i=e.createProgram(),s=["attribute highp vec4 aVertexPosition;","attribute vec2 aTextureCoord;","varying highp vec2 vTextureCoord;","void main(void) {"," gl_Position = aVertexPosition;"," vTextureCoord = aTextureCoord;","}"].join("\n"),a=e.createShader(e.VERTEX_SHADER);e.shaderSource(a,s),e.compileShader(a);var r=["precision highp float;","varying lowp vec2 vTextureCoord;","uniform sampler2D YTexture;","uniform sampler2D UTexture;","uniform sampler2D VTexture;","const mat4 YUV2RGB = mat4","("," 1.1643828125, 0, 1.59602734375, -.87078515625,"," 1.1643828125, -.39176171875, -.81296875, .52959375,"," 1.1643828125, 2.017234375, 0, -1.081390625,"," 0, 0, 0, 1",");","void main(void) {"," gl_FragColor = vec4( texture2D(YTexture, vTextureCoord).x, texture2D(UTexture, vTextureCoord).x, texture2D(VTexture, vTextureCoord).x, 1) * YUV2RGB;","}"].join("\n"),n=e.createShader(e.FRAGMENT_SHADER);e.shaderSource(n,r),e.compileShader(n),e.attachShader(i,a),e.attachShader(i,n),e.linkProgram(i),e.useProgram(i),e.getProgramParameter(i,e.LINK_STATUS)||console.log("[ER] Shader link failed.");var o=e.getAttribLocation(i,"aVertexPosition");e.enableVertexAttribArray(o);var l=e.getAttribLocation(i,"aTextureCoord");e.enableVertexAttribArray(l);var h=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,h),e.bufferData(e.ARRAY_BUFFER,new Float32Array([1,1,0,-1,1,0,1,-1,0,-1,-1,0]),e.STATIC_DRAW),e.vertexAttribPointer(o,3,e.FLOAT,!1,0,0);var c=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,c),e.bufferData(e.ARRAY_BUFFER,new Float32Array([1,0,0,0,1,1,0,1]),e.STATIC_DRAW),e.vertexAttribPointer(l,2,e.FLOAT,!1,0,0),e.y=new g(e),e.u=new g(e),e.v=new g(e),e.y.bind(0,i,"YTexture"),e.u.bind(1,i,"UTexture"),e.v.bind(2,i,"VTexture")}else console.log("[ER] WebGL not supported.")},y.prototype.renderFrame=function(t,e,i,s,a){if(this.gl){var r=this.gl;r.viewport(0,0,r.canvas.width,r.canvas.height),r.clearColor(0,0,0,0),r.clear(r.COLOR_BUFFER_BIT),r.y.fill(e,i,t.subarray(0,s)),r.u.fill(e>>1,i>>1,t.subarray(s,s+a)),r.v.fill(e>>1,i>>1,t.subarray(s+a,t.length)),r.drawArrays(r.TRIANGLE_STRIP,0,4)}else console.log("[ER] Render frame failed due to WebGL not supported.")},y.prototype.fullscreen=function(){var t=this.canvas;t.RequestFullScreen?t.RequestFullScreen():t.webkitRequestFullScreen?t.webkitRequestFullScreen():t.mozRequestFullScreen?t.mozRequestFullScreen():t.msRequestFullscreen?t.msRequestFullscreen():alert("This browser doesn't supporter fullscreen")},y.prototype.exitfullscreen=function(){document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen?document.msExitFullscreen():alert("Exit fullscreen doesn't work")},y.prototype.closeCanvas=function(){this.gl.clearColor(0,0,0,1),this.gl.clear(this.gl.DEPTH_BUFFER_BIT|this.gl.COLOR_BUFFER_BIT)};const m=0;function v(t){this.module=t}v.prototype.log=function(t){},v.prototype.logError=function(t){console.log("["+this.currentTimeStr()+"]["+this.module+"][ER] "+t)},v.prototype.logInfo=function(t){},v.prototype.logDebug=function(t){},v.prototype.currentTimeStr=function(){var t=new Date(Date.now());return t.getFullYear()+"-"+(t.getMonth()+1)+"-"+t.getDate()+" "+t.getHours()+":"+t.getMinutes()+":"+t.getSeconds()+":"+t.getMilliseconds()};const x=0,w=0;var T=0,S=null;function C(t,e=4){this.fileInfo=null,this.pcmPlayer=null,this.canvas=null,this.webglPlayer=null,this.callback=null,this.waitHeaderLength=524288,this.receivedLength=0,this.receivedFrameCount=0,this.receivedFrameTime=0,this.receivedAudioFrameCount=0,this.receivedAudioFrameTime=0,this.receivedFrameTotalCountTest=0,this.duration=0,this.pixFmt=0,this.videoWidth=0,this.videoHeight=0,this.yLength=0,this.uvLength=0,this.beginTimeOffset=0,this.decoderState=x,this.audioDecoderState=x,this.playerState=w,this.decoding=!1,this.decodeInterval=40,this.downloadTimer=null,this.chunkInterval=50,this.downloadSeqNo=0,this.downloading=!1,this.downloadProto=m,this.timeLabel=null,this.timeTrack=null,this.trackTimer=null,this.trackTimerInterval=500,this.displayDuration="00:00:00",this.audioEncoding="",this.audioChannels=0,this.audioSampleRate=0,this.seeking=!1,this.justSeeked=!1,this.urgent=!1,this.seekWaitLen=524288,this.seekReceivedLen=0,this.buffering=!1,this.threadNum=e,this.frameBuffer=[],this.isStream=!1,this.streamReceivedLen=0,this.firstAudioFrame=!0,this.streamPauseParam=null,this.freezeScreen=!1,this.recordEndCallback=null,this.seq=0,this.videoRenderTimer=null,this.openDecoderFailCnt=0,this.playerID=T++,this.logger=new v("Player["+this.playerID+"]"),this.snapJpegCallback=null,this.audioSampleFreq=0,this.audioEncFormat=0,this.hasSetAudioFormat=!1,this.firstIdrReceived=!1,this.fpsBegin=0,this.initDecodeWorker(t)}window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t,e){window.setTimeout(t,1e3/60)},window.cancelAnimationFrame=window.cancelRequestAnimationFrame||window.webkitCancelAnimationFrame||window.webkitCancelRequestAnimationFrame||window.mozCancelAnimationFrame||window.mozCancelRequestAnimationFrame||window.msCancelAnimationFrame||window.msCancelRequestAnimationFrame||window.oCancelAnimationFrame||window.oCancelRequestAnimationFrame||window.clearTimeout,String.prototype.startWith=function(t){return new RegExp("^"+t).test(this)},C.prototype.initDecodeWorker=function(t){var e=this;this.logger.logInfo("Player Version: 1.0"),this.decodeWorker=new Worker(t),this.decodeWorker.onmessage=function(t){var i=t.data;switch(i.t){case 2:0==i.subchl?e.onOpenDecoder(i):e.onOpenAudioDecoder(i);break;case 4:e.onVideoFrame(i);break;case 5:e.onAudioFrame(i);break;case 8:case 9:case 10:case 1:break;case 3:e.onCloseDecoder();break;case 11:e.onJpegFrame(i);break;case 13:e.onGetRecordFile(i)}};var i={t:14,s:this.playerID};this.decodeWorker.postMessage(i),this.initDecoder()},C.prototype.onGetRecordFile=function(t){this.logger.logInfo("record data len is "+t.d.length),this.recordEndCallback(new Uint8Array(t.d))},C.prototype.onUninitDecoder=function(){this.playerState=w,this.logger.logInfo("Uninit decoder OK.")},C.prototype.onCloseDecoder=function(){this.playerState=w,this.logger.logInfo("Close decoder OK.")},C.prototype.onJpegFrame=function(t){var e=new Uint8Array(t.d);this.snapJpegCallback(e)},C.prototype.getState=function(){return this.playerState},C.prototype.onInitDecoder=function(t){this.logger.logInfo("Init decoder response "+t.e+"."),0!=t.e&&this.reportPlayError(t.e)},C.prototype.onOpenDecoder=function(t){0==t.e?(this.onVideoParam(t.v),this.onAudioParam(t.a),this.decoderState=3,this.logger.logInfo("Decoder ready now."),this.playerState=1,this.reportPlayError(t.e)):++this.openDecoderFailCnt<100?(this.decoderState=x,this.receivedFrameCount=0,this.logger.logInfo("Open Decoder failed.open cnt = "+this.openDecoderFailCnt)):(this.logger.logInfo("Open Decoder cnt > openDecoderMaxTryCnt; Play can not work!"),this.playerState=5,this.stop(),this.reportPlayError(t.e))},C.prototype.onOpenAudioDecoder=function(t){1!=this.playerState&&this.logger.logInfo("this.playerState [ "+this.playerState+" ], is wrong."),0==t.e&&(this.onAudioParam(t.a),this.audioDecoderState=3,this.logger.logInfo("Audio Decoder ready now."))},C.prototype.reportPlayError=function(t,e,i){var s={error:t||0};this.callback&&this.callback(s)},C.prototype.onVideoParam=function(t){this.logger.logInfo("Video param duation:"+t.d+" pixFmt:"+t.p+" width:"+t.w+" height:"+t.h+"."),this.duration=t.d,this.pixFmt=t.p,this.videoWidth=t.w,this.videoHeight=t.h,this.yLength=this.videoWidth*this.videoHeight,this.uvLength=this.videoWidth/2*(this.videoHeight/2)},C.prototype.onAudioParam=function(t){this.logger.logInfo("Audio param sampleFmt:"+t.f+" channels:"+t.c+" sampleRate:"+t.r+".");var e=t.f,i=t.c,s=t.r;if(0!=i&&0!=e){var a="16bitInt";switch(e){case 0:a="8bitInt";break;case 1:a="16bitInt";break;case 2:a="32bitInt";break;case 3:a="32bitFloat";break;default:this.logger.logError("Unsupported audio sampleFmt "+e+"!")}this.logger.logInfo("Audio encoding "+a+"."),this.pcmPlayer=new PCMPlayer({encoding:a,channels:i,sampleRate:s,flushingTime:5e3}),this.audioEncoding=a,this.audioChannels=i,this.audioSampleRate=s}else this.logger.logInfo("No Audio data")},C.prototype.displayAudioFrame=function(t){return 1==this.playerState&&(this.isStream&&this.firstAudioFrame&&(this.firstAudioFrame=!1,this.beginTimeOffset=t.s),this.pcmPlayer.play(new Uint8Array(t.d)),!0)},C.prototype.onAudioFrame=function(t){this.bufferFrame(t)},C.prototype.startDecoding=function(){var t={t:5,i:this.urgent?0:this.decodeInterval};this.decodeWorker.postMessage(t),this.decoding=!0},C.prototype.skipDecode=function(t){var e={t:6,s:t};this.decodeWorker.postMessage(e)},C.prototype.stopDecoding=function(){var t={t:6};this.decodeWorker.postMessage(t),this.decoding=!1},C.prototype.processSnapCmd=function(t){if(this.snapCmdQue&&0!=this.snapCmdQue.length){cmd=this.snapCmdQue[0];var e={t:kSnapReq,d:t,crop_x:cmd.crop_x,crop_y:cmd.crop_y,crop_w:cmd.crop_w,crop_h:cmd.crop_h,src_w:cmd.src_w,src_h:cmd.src_h,dst_w:cmd.dst_w,dst_h:cmd.dst_h};this.decodeWorker.postMessage(e),this.snapCmdQue.shift()}},C.prototype.setVideoFormat=function(t,e,i){},C.prototype.onVideoFrame=function(t){this.bufferFrame(t)},C.prototype.bufferFrame=function(t){if(1==this.freezeScreen)for(0==this.frameBuffer.length&&this.frameBuffer.push(t);this.frameBuffer.length>1;)this.frameBuffer.shift();else this.frameBuffer.push(t),this.frameBuffer.length>=4&&(this.frameBuffer.shift(),this.logger.logInfo("Buffer Queue len is "+this.frameBuffer.length))},C.prototype.getBufferTimerLength=function(){if(!this.frameBuffer||0==this.frameBuffer.length)return 0;let t=this.frameBuffer[0];return this.frameBuffer[this.frameBuffer.length-1].s-t.s},C.prototype.displayLoop=function(){this.videoRenderTimer=requestAnimationFrame(this.displayLoop.bind(this));for(let e=0;e<=4&&0!=this.frameBuffer.length;++e){var t=this.frameBuffer[0];switch(t.t){case 5:this.displayAudioFrame(t)&&this.frameBuffer.shift();break;case 4:this.displayVideoFrame(t)&&0==this.freezeScreen&&this.frameBuffer.shift();break;default:return}}},C.prototype.displayVideoFrame=function(t){return 1==this.playerState&&(this.videoWidth*this.videoHeight*3/2!=t.d.length?(console.log("webgl length is wrong !!!!!! width = "+this.videoWidth+", height = "+this.videoHeight+", frame len = "+t.d.length),!0):(this.renderVideoFrame(t.d),!0))},C.prototype.renderVideoFrame=function(t){this.webglPlayer&&this.webglPlayer.gl&&this.webglPlayer.renderFrame(t,this.videoWidth,this.videoHeight,this.yLength,this.uvLength)},C.prototype.initDecoder=function(){this.logger.logInfo("Initializing decoder.");var t={t:0,s:-1};this.decodeWorker.postMessage(t)},C.prototype.pauseDecoding=function(){var t={t:8};this.decodeWorker.postMessage(t),this.decoding=!1},C.prototype.onDataUnderDecoderIdle=function(t){if(this.receivedFrameCount>=1){this.decoderState=1;var e={t:2,subchl:0,skip_loopfilter:t,threadNum:this.threadNum};this.decodeWorker.postMessage(e)}},C.prototype.onDataUnderDecoderReady=function(){},C.prototype.onDataUnderDecoderInitializing=function(){},C.prototype.setCallback=function(t,e){"webglLost"==t&&(S=e)},C.prototype.webglContextLost=function(){this.webglPlayer=null,S()},C.prototype.play=function(t,e,i,s,a,r){this.callback=i;this.logger.logInfo("play start!!!!, player status is "+this.playerState);do{if(this.playerState!=w){this.logger.logInfo("player status is ["+this.playerState+"], can not play!");break}this.waitHeaderLength=1==r?131072:s,this.canvas=e,this.isStream=r,this.canvas.addEventListener("webglcontextlost",this.webglContextLost.bind(this)),this.webglPlayer=new y(this.canvas,{preserveDrawingBuffer:!1}),this.playerState=3,this.displayLoop(),this.logger.logInfo("play end!!!!")}while(0);return{e:0,m:"Success"}},C.prototype.clearCanvas=function(){this.webglPlayer&&this.webglPlayer.closeCanvas()},C.prototype.reWEBGL=function(t){this.webglPlayer=null,this.webglPlayer=new y(t,{preserveDrawingBuffer:!1})},C.prototype.stop=function(t){if(this.logger.logInfo("Stop."),1!=this.playerState&&5!=this.playerState)return this.logger.logInfo("Player currentr state is ["+this.playerState+"], can not Stop."),-1;null!=this.videoRendererTimer&&(cancelAnimationFrame(this.videoRenderTimer),this.videoRendererTimer=null,this.logger.logInfo("Video renderer timer stopped.")),t&&this.webglPlayer&&this.webglPlayer.closeCanvas(),this.logger.logInfo("Closing decoder.");var e={t:3,subchl:0};this.decodeWorker.postMessage(e),this.fileInfo=null,this.callback=null,this.duration=0,this.pixFmt=0,this.beginTimeOffset=0,this.decoderState=x,this.playerState=4,this.decoding=!1,this.frameBuffer=[],this.receivedLength=0,this.receivedFrameCount=0,this.streamReceivedLen=0,this.firstAudioFrame=!0,this.urgent=!1,this.receivedAudioFrameCount=0,this.audioDecoderState=x,this.pcmPlayer&&(this.pcmPlayer.destroy(),this.pcmPlayer=null,this.logger.logInfo("Pcm player released.")),this.openDecoderFailCnt=0,this.logger.logInfo("Stop end.")},C.prototype.putData=function(t,e=0){if(1==this.playerState||3==this.playerState){if(this.receivedLength+=t.length,this.receivedFrameCount+=1,this.receivedFrameCount%500==0&&(this.logger.logInfo(" 500 Frame Time Interval = "+(Date.now()-this.receivedFrameTime)),this.receivedFrameTime=Date.now()),this.decoderState==x){var i={t:19,subchl:0};this.decodeWorker.postMessage(i)}var s={t:4,d:t,subchl:0};switch(this.decodeWorker.postMessage(s),this.decoderState){case x:this.onDataUnderDecoderIdle(e);break;case 1:this.onDataUnderDecoderInitializing();break;case 3:this.onDataUnderDecoderReady()}}else this.logger.logError("Player state[ "+this.playerState+" ], can not send data to decoder!")},C.prototype.setAudioFormat=function(t,e){this.logger.logInfo("set audio format: freq = "+t+", format = "+e);var i={t:17,fmt:e,freq:t,bitwidth:16,nr_chl:1};this.decodeWorker.postMessage(i)},C.prototype.putAudioData=function(t){if(1==this.playerState||3==this.playerState){if(this.audioDecoderState==x){var e={t:19,subchl:1};this.decodeWorker.postMessage(e)}var i={t:4,d:t,subchl:1};switch(this.decodeWorker.postMessage(i),this.receivedAudioFrameCount+=1,this.receivedAudioFrameCount%500==0&&(this.logger.logInfo(" 500 Audio Frame Time Interval = "+(Date.now()-this.receivedAudioFrameTime)),this.receivedAudioFrameTime=Date.now()),this.audioDecoderState){case x:if(this.receivedAudioFrameCount<=5)break;this.audioDecoderState=1;e={t:2,subchl:1};this.logger.logInfo("Open Audio Codec"),this.decodeWorker.postMessage(e)}}else this.logger.logError("Player state[ "+this.playerState+" ], can not send data to decoder!")},C.prototype.destroy=function(){var t={t:18};this.decodeWorker.postMessage(t),this.decodeWorker.terminate()},C.prototype.increaseVolume=function(t){console.log("vol is "+t/100),this.pcmPlayer.volume(t/100)},C.prototype.decreaseVolume=function(t){console.log("vol is "+t/100),this.pcmPlayer.volume(t/100)},C.prototype.snapPicture=function(t){this.logger.logInfo("snap Pic!!"),this.snapJpegCallback=t;var e={t:10};this.decodeWorker.postMessage(e)},C.prototype.digitZoom=function(t,e,i,s,a,r,n,o){},C.prototype.hide=function(t){if(this.logger.logInfo("hide  =  "+t),1==t)var e={t:12};else e={t:13};this.decodeWorker.postMessage(e)},C.prototype.startRecord=function(t){this.logger.logInfo("start Record!!!."),this.recordEndCallback=t;var e={t:15};this.decodeWorker.postMessage(e)},C.prototype.stopRecord=function(){var t={t:16};this.decodeWorker.postMessage(t)},C.prototype.freeze=function(t){this.freezeScreen=t};var P=null,A=[],b=1;function R(t,e,i,s){return A=s,b=e,(P=t).innerHTML="",function(){for(var t=P.offsetWidth,e=P.offsetHeight,i=[],s=0;s<b;s++){var a=document.createElement("div"),r=document.createElement("canvas");a.addEventListener("contextmenu",(function(t){return"DIV"==t.target.tagName&&t.preventDefault(),!1}),!1),r.setAttribute("id","canvas"+s),k(a,{width:t/Math.sqrt(b)+"px",height:e/Math.sqrt(b)+"px",boxSizing:"border-box",textAlign:"left",display:"inline-block",verticalAlign:"top",border:"1px solid #d0daeb"}),D(r,t/b,e,A[s]),a.appendChild(r),P.appendChild(a),i.push("canvas"+s)}return i}()}function D(t,e,i,s,a){var r=function(t,e,i){if(!i)return[t,e];if(t/e>i)return[e*i,e];if(t/e<i)return[t,t/i];return[t,e]}(e-=2,i-=2,s);return t.style.width=r[0],t.style.height=r[1],t.style.marginTop=(i-r[1])/2+"px",t.style.marginLeft=(e-r[0])/2+"px",t.style.background="black",t.width=r[0],t.height=r[1],t}function k(t,e){Object.keys(e).forEach((function(i){t.style[i]=e[i]}))}function F(t){const{ip:e,port:i,chn:s,subtype:a,container:r,decoderUrl:n}=t,o=[16/9,16/9],l=t.isPlayback||!1,h=t.startTime||"",c=t.endTime||"",d=t.isHttps||!1?"wss":"ws",u=t.threadNum||4;this.ip=e,this.port=i,this.chn=s,this.subtype=a,this.player=null,this.playControl=null,this.container=document.querySelector(r),this.opt=l?{ch:s,subtype:a,Type:1,wsURL:`${d}://${e}:${i}/ws/vod-pav/${s}_${a}`,rtspURL:`rtsp://${e}:${i}/vod-pav/${s}_${a}`,username:"admin",password:"admin",decodeMode:"canvas",fullScreen:!0,skip_loopfilter:1,params:{StartTime:h,EndTime:c,Timestamp:0}}:{ch:s,subtype:a,Type:0,wsURL:`${d}://${e}:${i}/ws/pav/${s}_${a}?track=true`,rtspURL:`rtsp://${e}:${i}/pav/${s}_${a}?track=true`,username:"admin",password:"admin",decodeMode:"canvas",fullScreen:!0,skip_loopfilter:1},this.init=function(){this.playControl=new p(this.opt),this.player||(this.player=new C(n,u)),this.canvasIds=R(this.container,1,0,o);let t=this.container.childNodes[0].childNodes[0];this.canvasEle1=t,this.playControl.init(this.canvasEle1,this.player,null,this.opt),l&&this.playControl.isPlayback(!0)},this.play=function(){this.playControl.connect()},this.drawTrack=function(t){if(!this.playControl)return void console.error("Error! playControl is undefined!");let e=this.container.childNodes[0].childNodes[0];this.playControl&&this.playControl.showIVS(e,t,0)},this.changeChannel=function(t){if(!this.playControl)return void console.error("Error! playControl is undefined!");this.chn=t;let s={wsURL:`${d}://${e}:${i}/ws/pav/${t}_${a}?track=true`,rtspURL:`rtsp://${e}:${i}/pav/${t}_${a}?track=true`};this.playControl.changeChannel(s),this.playControl.removeOSDAPI()},this.stop=function(){this.playControl.close(),this.playControl=null,this.player.stop()}}export{F as CreatePlayer};
