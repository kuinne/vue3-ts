const CACHE_BUFFER_SIZE=1048576,Decoder_Invalid=1,Decoder_Initialized=Decoder_Invalid+1,Decoder_Opened=Decoder_Initialized+1,Decoder_Closed=Decoder_Opened+1;function Decoder(){this.logger=new Logger("Decoder"),this.coreLogLevel=1,this.accurateSeek=!0,this.wasmLoaded=!1,this.tmpReqQue=[],this.cacheBuffer=null,this.decodeTimer=null,this.videoCallback=null,this.audioCallback=null,this.requestCallback=null,this.decodeTimerInterval=null,this.decodeTimerStart=!1,this.useDecoderTimer=!1,this.dropYUVDataFlag=!1,this.state=Decoder_Invalid,this.currentTime=0,this.yuvFrameCnt=0,this.decoderID=0,this.sendDataTime=null}function onWasmLoaded(){self.decoder?self.decoder.onWasmLoaded():console.log("[ER] No decoder!")}self.Module={onRuntimeInitialized:function(){onWasmLoaded()}},self.Module.mainScriptUrlOrBlob="common.js",self.Module.mainScriptUrlOrBlob="libffmpeg.js",self.importScripts("common.js"),self.importScripts("libffmpeg.js"),Decoder.prototype.initDecoder=function(e){var o=-1;do{if(this.state!=Decoder_Invalid){o=-1,this.logger.log("Decoder state is ["+this.state+"], can not initial.");break}o=Module._initDecoder(e,this.coreLogLevel,this.decoderID),this.logger.logInfo("initDecoder return "+o+"."),0==o?(this.cacheBuffer=Module._malloc(1048576),this.state=Decoder_Initialized):o=-1}while(0)},Decoder.prototype.uninitDecoder=function(e){this.logger.logInfo("Begin unintDecoder.");Module._uninitDecoder();this.state=Decoder_Invalid,null!=this.cacheBuffer&&(Module._free(this.cacheBuffer),this.cacheBuffer=null);var o={t:kUninitDecoderRsp,e:0};self.postMessage(o)},Decoder.prototype.openDecoder=function(e,o,t,r){var d=Module._malloc(28),s=[o,t,0,0,0,r];Module.HEAPU32.set(s,d/4);var i=Module._openDecoder(d,7,this.videoCallback,this.audioCallback,this.requestCallback,e);if(0==i){var c=d>>2,a=Module.HEAP32.subarray(c,c+7),n=a[0],l=a[1],u=a[2],h=a[3],f=a[4],g=a[5],p=a[6],D={t:kOpenDecoderRsp,e:i,v:{d:n,p:l,w:u,h:h},a:{f:f,c:g,r:p},subchl:e};self.postMessage(D),this.state=Decoder_Opened}else{D={t:kOpenDecoderRsp,e:i,subchl:e};self.postMessage(D)}Module._free(d)},Decoder.prototype.closeDecoder=function(e){this.logger.logInfo("closeDecoder."),1==this.useDecoderTimer&&this.decodeTimer&&(this.decodeTimerStart=!1,cancelAnimationFrame(this.decodeTimer),this.decodeTimer=null,this.logger.logInfo("Decode timer stopped."));Module._closeDecoder(e);this.state=Decoder_Closed;var o={t:kCloseDecoderRsp,e:0};self.postMessage(o)},Decoder.prototype.startDecoding=function(e){this.logger.logInfo("Start decoding."),1==this.useDecoderTimer&&(this.decodeTimer&&(this.decodeTimerStart=!1,cancelAnimationFrame(this.decodeTimer)),this.decodeTimerStart=!0,this.decodeTimer=requestAnimationFrame(this.decode.bind(this)),this.logger.logInfo("Start decoding. decoderInterval = "+e+" ms."),this.decodeTimerInterval=e)},Decoder.prototype.stopDecoding=function(){this.logger.logInfo("Stop decoding."),1==this.useDecoderTimer&&(this.decodeTimerStart=!1,this.decodeTimer&&(cancelAnimationFrame(this.decodeTimer),this.decodeTimer=null,this.logger.logInfo("clear TIMER")))},Decoder.prototype.pauseDecoding=function(){this.logger.logInfo("Pause decoding."),1==this.useDecoderTimer&&(this.decodeTimerStart=!1,this.decodeTimer&&(cancelAnimationFrame(this.decodeTimer),this.decodeTimer=null))},Decoder.prototype.resumeDecoding=function(){this.logger.logInfo("Resume decoding."),1==this.useDecoderTimer&&(this.decodeTimer&&cancelAnimationFrame(this.decodeTimer),this.decodeTimerStart=!0,this.decodeTimer=requestAnimationFrame(this.decode.bind(this)))},Decoder.prototype.decode=function(){var e=Module._decodeOnePacket();if(7==e){self.decoder.logger.logInfo("Decoder finished."),self.decoder.pauseDecoding();var o={t:kDecodeFinishedEvt};self.postMessage(o)}for(;9==e;)self.decoder.logger.logInfo("One old frame"),e=Module._decodeOnePacket();1==this.useDecoderTimer&&1==self.decoder.decodeTimerStart&&requestAnimationFrame(self.decoder.decode.bind(self.decoder))},Decoder.prototype.cleanDecoderBuffer=function(){Module._cleanDecoderbuffer()},Decoder.prototype.sendData=function(e,o){var t=new Uint8Array(e);if(t.length<=1048576)Module.HEAPU8.set(t,this.cacheBuffer);else{this.logger.logInfo("Warning !!! data len "+t.length+"  > CACHE_BUFFER_SIZE"),Module._free(this.cacheBuffer);let e=t.length+32&-32;this.cacheBuffer=Module._malloc(e),Module.HEAPU8.set(t,this.cacheBuffer)}ret=Module._sendData(this.cacheBuffer,t.length,o),1==this.useDecoderTimer&&ret<0&&(self.decoder.decodeTimerStart=!1,cancelAnimationFrame(this.decodeTimer),self.decoder.decodeTimerStart=!0,requestAnimationFrame(self.decoder.decode.bind(self.decoder)))},Decoder.prototype.seekTo=function(e){var o=this.accurateSeek?1:0,t=Module._seekTo(e,o),r={t:kSeekToRsp,r:t};self.postMessage(r)},Decoder.prototype.dropYUV=function(e){this.dropYUVDataFlag=1==e},Decoder.prototype.setDecoderID=function(e){this.decoderID=e,this.logger=null,this.logger=new Logger("Decoder["+this.decoderID+"]"),this.logger.logInfo("decoder id is "+this.decoderID)},Decoder.prototype.startRecord=function(){Module._startRecord(this.recordCallback)},Decoder.prototype.stopRecord=function(){Module._stopRecord()},Decoder.prototype.setAudioFormat=function(e,o,t,r){Module._setAudioFormat(e,o,t,r)},Decoder.prototype.destroyDecoder=function(){Module._destroyDecoder(),self.close()},Decoder.prototype.startRcvData=function(e){Module._startRcvData(e)},Decoder.prototype.skipDecode=function(e){Module._skipDecode(e)},Decoder.prototype.processReq=function(e){switch(e.t){case kInitDecoderReq:this.logger.logInfo("initDecoder."),this.initDecoder(e.s,e.c);break;case kUninitDecoderReq:this.logger.logInfo("kUninitDecoderReq."),this.uninitDecoder(e.subchl);break;case kOpenDecoderReq:this.logger.logInfo("kOpenDecoderReq."),this.openDecoder(e.subchl,0,e.skip_loopfilter,e.threadNum);break;case kCloseDecoderReq:this.logger.logInfo("kCloseDecoderReq."),this.closeDecoder(e.subchl);break;case kStartDecodingReq:break;case kStopDecodingReq:this.skipDecode(e.s);break;case kPauseDecodingReq:break;case kFeedDataReq:this.sendData(e.d,e.subchl);break;case kSeekToReq:this.seekTo(e.ms);break;case kSnapJpegReq:this.snapJpeg();break;case kCleanDecoderBufferReq:this.cleanDecoderBuffer();break;case kResumeDecodingReq:break;case kDropYUVReq:this.dropYUV(!0);break;case kNotDropYUVReq:this.dropYUV(!1);break;case kSetDecoderId:this.setDecoderID(e.s);break;case kStartRecord:this.logger.logInfo("kStartRecord."),this.startRecord();break;case kStopRecord:this.logger.logInfo("kStopRecord."),this.stopRecord();break;case kSetAudioFormat:this.logger.logInfo("kSetAudioFormat."),this.setAudioFormat(e.fmt,e.freq,e.bitwidth,e.nr_chl);break;case kDestroyDecoder:this.logger.logInfo("kDestroyDecoder."),this.destroyDecoder();break;case kStartRcvData:this.logger.logInfo("kStartRcvData."),this.startRcvData(e.subchl);break;default:this.logger.logError("Unsupport messsage "+e.t)}},Decoder.prototype.snapJpeg=function(){Module._snapJpeg(this.jpegCallback)},Decoder.prototype.cacheReq=function(e){e&&this.tmpReqQue.push(e)},Decoder.prototype.onWasmLoaded=function(){for(this.logger.logInfo("Wasm loaded."),this.wasmLoaded=!0,this.videoCallback=Module.addFunction(function(e,o,t){if(1!=self.decoder.dropYUVDataFlag){var r=Module.HEAPU8.subarray(e,e+o),d=new Uint8Array(r),s={t:kVideoFrame,s:t,d:d};self.postMessage(s,[s.d.buffer])}},"viid"),this.audioCallback=Module.addFunction(function(e,o,t){var r=Module.HEAPU8.subarray(e,e+o),d=new Uint8Array(r),s={t:kAudioFrame,s:t,d:d};self.postMessage(s,[s.d.buffer])},"viid"),this.jpegCallback=Module.addFunction(function(e,o,t){var r=Module.HEAPU8.subarray(e,e+o),d=new Uint8Array(r),s={t:kSnapRsp,s:t,d:d};self.postMessage(s,[s.d.buffer])},"viid"),this.recordCallback=Module.addFunction(function(e,o){var t=Module.HEAPU8.subarray(e,e+o),r=new Uint8Array(t),d={t:kGetRecordFileRsp,d:r};self.postMessage(d,[d.d.buffer])},"vii"),this.requestCallback=Module.addFunction(function(e,o){var t={t:kRequestDataEvt,o:e,a:o};self.postMessage(t)},"vii");this.tmpReqQue.length>0;){var e=this.tmpReqQue.shift();this.processReq(e)}},self.decoder=new Decoder,self.onmessage=function(e){if(self.decoder){var o=e.data;self.decoder.wasmLoaded?self.decoder.processReq(o):self.decoder.cacheReq(o)}else console.log("[ER] Decoder not initialized!")},self.skipDecode=function(e){self.decoder.skipDecode(e)};